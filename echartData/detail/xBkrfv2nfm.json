{"status":0,"data":{"cid":"xBkrfv2nfm","authorUid":"bd-1025214267","authorUserName":"d***e","title":"省市区下钻","description":"高德api结合echart完成省市区地图下钻","latestVersion":5,"alwaysLatest":1,"createTime":"2018-07-06T09:31:56.000Z","lastUpdateTime":"2018-07-06T09:31:56.000Z","auth":2,"uid":"bd-1025214267","publishedVersion":0,"forkFrom":"-","isSpam":0,"version":5,"parentVersion":4,"echartsVersion":"4.1.0","versionCreateTime":"2018-07-20T09:38:32.000Z","code":"\r\n\r\n/*\r\n* 高德地图结合echarts完成地图省市区下钻。\r\n* 1.通过高德地图插件获取区域数据。\r\n* 2.使用echart map。\r\n* \r\n* 版本：\r\n*  #1：使用geo和scatter\r\n*  #2: 使用map\r\n*  #3: 使用geo和pie\r\n*  #4: 使用geo和pie, 添加缩放与拖拽(惯性拖拽有问题)。对echart源码做了轻微修改。\r\n*  #5: 使用geo和pie/line, 修改缩放相关操作。\r\n*/\r\n\r\nvar GDEcharts = function(options){\r\n\tthis.container = document.getElementById(options.containerId);\r\n\tthis.adcode = options.adcode ? options.adcode : 100000;\r\n\tthis.echartOption = options.echartOption;\r\n\tthis.gridWidth = 60;\r\n\tthis.gridHeight = 40;\r\n\r\n\tthis.geoData = {\"type\": \"FeatureCollection\",\"features\": []};\r\n\tthis.breadcrumbData = [{name: '全国', adcode: 100000}];\r\n\tthis.testData = [];\r\n\r\n\tthis.echart;\r\n\tthis.districtExplorer;\r\n\r\n\tthis.init();\r\n}\r\nGDEcharts.prototype = {\r\n\tconstructor: constructor,\r\n\r\n\tinit: function(){\r\n\t\tif(!this.echart) this.initEchart();\r\n\t\tif(!this.districtExplorer) this.initDistrictExplorer();\r\n\t\tthis.echart.showLoading();\r\n\r\n\t\tvar _this = this;\r\n\t\tsetTimeout(function(){\r\n\t\t\t//通过adcode获取下级城市数据\r\n\t\t\t_this.districtExplorer.loadAreaNode(_this.adcode, function(error, areaNode) {\r\n\t            _this.geoData.features = areaNode.getSubFeatures();\r\n\t            echarts.registerMap(_this.adcode, _this.geoData);\r\n\r\n\t            _this.createBreadcrumb(areaNode);\r\n\t            _this.createTestData();\r\n\t            _this.renderChart();\r\n\t        }); \r\n\t\t}, 500)\r\n\t\t\r\n\t\treturn this;\r\n\t},\r\n\r\n\tinitEchart: function(){\r\n\t\tthis.echart = echarts.init(this.container);\r\n\r\n\t\tvar _this = this;\r\n\t\t_this.echart.on('georoam', function(d){   \t\r\n\t\t   \t_this.resetChart();\t   \r\n\t\t});\r\n\r\n\t\t_this.echart.on('click', function(event){\r\n\t\t\tvar componentType = event.componentType;\r\n\t\t\tvar childrenNum = 0;\r\n\r\n\t\t\t//根据目标类型获取adocde和下级区域数量\r\n\t\t\tif(event.componentType == 'geo') {\r\n\t\t\t\tvar name = event.name;\r\n\r\n\t\t\t\t//通过名称从geoData获取数据\r\n\t\t\t\tvar data = _this.geoData.features;\r\n\t\t\t\tfor(var i = 0, len = data.length; i < len; i++){\r\n\t\t\t\t\tvar properties = data[i].properties;\r\n\t\t\t\t\tif(properties.name == name){\r\n\t\t\t\t\t\tchildrenNum = properties.childrenNum;\r\n\t\t\t\t\t\t_this.adcode = properties.adcode;\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}else{\r\n\t\t\t\tchildrenNum = event.data.childrenNum;\r\n\t\t\t\t_this.adcode = event.data.adcode;\r\n\t\t\t}\r\n\r\n\r\n\t\t\tif(childrenNum > 0){\r\n\t\t\t\t_this.init();\r\n\t\t\t}else{\r\n\t\t\t\tconsole.log('无下级区域！');\r\n\t\t\t}\r\n\t\t})\r\n\r\n\t},\r\n\r\n\tinitDistrictExplorer: function(){\r\n\t\tvar _this = this;\r\n\t\tif(!_this.districtExplorer){\r\n\t\t\tAMapUI.loadUI(['geo/DistrictExplorer'], function(DistrictExplorer) {\r\n                _this.districtExplorer= new DistrictExplorer();\r\n            });\r\n\t\t}\t\r\n\t},\r\n\r\n\trenderChart: function(){\r\n\t\tvar geo = this.echartOption.geo;\r\n\t\tgeo.map = this.adcode;\r\n\t\tswitch(this.adcode){\r\n            case 100000://全国\r\n                geo.zoom = 1.5;\r\n\t\t\t\tgeo.center = [104.114129, 34.550339];\r\n                break;\r\n            case 460000://海南省\r\n            \tgeo.zoom = 5;\r\n\t\t\t\tgeo.center = [110.33119, 19.031971];\r\n                break;     \r\n            default:\r\n                geo.zoom = null;\r\n\t\t\t\tgeo.center = null;\r\n                break;\r\n        }\r\n        \r\n\t\tthis.echart.hideLoading();\r\n\t\tthis.echart.clear();\r\n\t\tthis.echart.setOption(this.echartOption);\r\n\t\tthis.addOverLays(['pie', 'line']);\r\n\t},\r\n\r\n\tresetChart: function(){\r\n\t\tvar _this = this;\r\n\t\tvar curOption = this.echart.getOption();\r\n\t\tvar series = curOption.series;\r\n\t\tvar grid = curOption.grid;\r\n\r\n\t\tif(grid && grid.length > 0){\r\n\t\t\tgrid.forEach(function(item, index){\r\n\t\t\t\tvar position = _this.echart.convertToPixel('geo', item.dCenter);\r\n\t\t\t\titem.left = position[0] - (_this.gridWidth / 2);\r\n\t\t\t\titem.top = position[1] - (_this.gridHeight / 2);\r\n\t\t\t})\r\n\t\t}\r\n\t\t\r\n\t\tseries.forEach(function(item, index){\r\n\t\t\tif(item.center){\r\n\t\t\t\titem.center = _this.echart.convertToPixel('geo', item.dCenter);\r\n\t\t\t}\r\n\t\t})\r\n\t\t_this.echart.setOption(curOption);\r\n\t},\r\n\r\n\taddOverLays: function(arr){\r\n\t\tif(arr && arr.length > 0){\r\n\r\n\t\t\tthis.echartOption.grid = [];\r\n\t\t\tthis.echartOption.xAxis = [];\r\n\t\t\tthis.echartOption.yAxis = [];\r\n\t\t\tthis.echartOption.series = [];\r\n\r\n\t\t\tthis.creatSeries(arr);\r\n\t\t\tconsole.log(this.echartOption);\r\n\t\t\tthis.echart.clear();\r\n\t\t\tthis.echart.setOption(this.echartOption);\r\n\t\t}\r\n\t},\r\n\tcreatSeries: function(chartTypeArr){\r\n\t\tvar _this = this;\r\n\t\tvar data = this.testData;\r\n\r\n\t\tvar typeLen = chartTypeArr.length;\r\n\t\tdata.forEach(function(item, index){\r\n\t\t\tvar position = _this.echart.convertToPixel('geo', item.center);\r\n\t\t\tchartTypeArr.forEach(function(cTtem, tcIndex){\r\n\t\t\t\tswitch(cTtem){\r\n\t\t\t\t\tcase 'pie':\r\n\t\t\t\t\t\t_this.createPieSeries(item, index, position);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\tcase 'line': \r\n\t\t\t\t\t\t//_this.createLineSeries(item, index, position);\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t})\t\r\n\t},\r\n\tcreatePieSeries: function(item, index, position){\r\n\t\tthis.echartOption.series.push({\r\n            name: item.name,\r\n            type: 'pie',\r\n            radius : this.gridHeight / 2,\r\n            dCenter: item.center,\r\n            center: position,\r\n            data: [{value: Math.round(Math.random() * 420 + 80), name:'直接访问', adcode: item.adcode, childrenNum: item.childrenNum},\r\n\t\t\t\t\t{value: Math.round(Math.random() * 420 + 80), name:'邮件营销', adcode: item.adcode, childrenNum: item.childrenNum},\r\n\t\t\t\t\t{value: Math.round(Math.random() * 420 + 80), name:'联盟广告', adcode: item.adcode, childrenNum: item.childrenNum}],\r\n            label: {\r\n                show: false,\r\n            },\r\n            animationType: 'scale',\r\n            animationEasing: 'elasticOut',\r\n            animationDelay: function (idx) {\r\n                return Math.random() * 200;\r\n            }\r\n        })\t\t\r\n\t},\r\n\r\n\tcreateLineSeries: function(item, index, position){\r\n\t\tthis.echartOption.grid.push({\r\n\t\t\tleft: position[0] - (this.gridWidth / 2), \r\n\t\t\ttop: position[1] - (this.gridHeight / 2), \r\n\t\t\twidth: this.gridWidth, \r\n\t\t\theight: this.gridHeight, \r\n\t\t\tdCenter: item.center\r\n\t\t});\r\n\r\n\t\tthis.echartOption.xAxis.push({\r\n\t\t\tgridIndex: index, min: 0, max: 20, \r\n\t\t\taxisLine: {show: false}, \r\n\t\t\taxisTick: {show: false}, \r\n\t\t\taxisLabel: {show: false}, \r\n\t\t\tsplitLine: {show: false}\r\n\t\t});\r\n\r\n\t\tthis.echartOption.yAxis.push({\r\n\t\t\tgridIndex: index, min: 0, max: 20, \r\n\t\t\taxisLine: {show: false}, \r\n\t\t\taxisTick: {show: false}, \r\n\t\t\taxisLabel: {show: false}, \r\n\t\t\tsplitLine: {show: false}\r\n\t\t});\r\n\r\n\t\tthis.echartOption.series.push({\r\n\t\t\ttype: 'line',\r\n\t\t\tname: item.name,\r\n\t\t\txAxisIndex: index,\r\n        \tyAxisIndex: index,\r\n        \tlineStyle: {\r\n        \t\tcolor: '#ff6004'\r\n        \t},\r\n        \titemStyle: {\r\n        \t\tborderColor: '#ff6004',\r\n        \t\tborderWidth: 1\r\n        \t},\r\n    \t\tdata: [\r\n    \t\t\t[2, Math.round(Math.random() * 17 + 3)], \r\n    \t\t\t[5, Math.round(Math.random() * 17 + 3)], \r\n    \t\t\t[10, Math.round(Math.random() * 17 + 3)], \r\n    \t\t\t[12, Math.round(Math.random() * 17 + 3)], \r\n    \t\t\t[18, Math.round(Math.random() * 17 + 3)]]\r\n\t\t});\r\n\t},\r\n\r\n\tcreateTestData: function(){\r\n\t\tvar data = [];\r\n\t\tvar features = this.geoData.features;\r\n\r\n\t\tfor(var i = 0, len = features.length; i < len; i++) {\r\n\t\t\tvar properties = features[i].properties;\r\n\t\t\tvar center = properties.centroid ? properties.centroid : properties.center;\r\n\r\n\t\t\tvar d = {\r\n\t\t\t\tname: properties.name, \r\n\t\t\t\tcenter: center,\r\n\t\t\t\tadcode: properties.adcode, \r\n\t\t\t\tchildrenNum: properties.childrenNum\r\n\t\t\t}\r\n\r\n            data.push(d);\r\n\t\t}\r\n\r\n\t\tthis.testData = data;\r\n\t},\r\n\r\n\tcreateBreadcrumb: function(areaNode){\r\n\t\tvar props = areaNode.getProps();\r\n\t\t\r\n\t\t//遍历当前导航数据，判断目标数据是否已存在，并重新构造数据\r\n\t\tvar breadcrumbData =  this.breadcrumbData;\r\n\t\tvar newBreadcrumbData = [];\r\n\t\tvar isIn = false;\r\n\t\tfor(var i = 0, len = breadcrumbData.length; i < len; i++){\r\n\t\t\tnewBreadcrumbData.push(breadcrumbData[i]);\r\n\t\t\tif(breadcrumbData[i].adcode == props.adcode) {\r\n\t\t\t\tisIn = true;\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(isIn) {\r\n\t\t\tthis.breadcrumbData = newBreadcrumbData;\r\n\t\t}else{\r\n\t\t\tthis.breadcrumbData.push({name: props.name, adcode: props.adcode});\r\n\t\t}\r\n\t\t\r\n\t\t//根据最新导航数据，构造echart option\r\n        var graphic = [];\r\n        var concatString = '';\r\n        breadcrumbData = this.breadcrumbData;\r\n        for(var j = 0, len = breadcrumbData.length; j < len; j++){\r\n        \tbreadcrumbData[j].concatString = concatString;\r\n        \tgraphic = graphic.concat(this.createBreadcrumbOption(breadcrumbData[j], j));\r\n        \tconcatString = concatString + breadcrumbData[j].name;\r\n        }\r\n\r\n\t\tthis.echartOption.graphic = graphic;\r\n\t},\r\n\t\r\n\tcreateBreadcrumbOption: function(item, index){\r\n\t\tvar _this = this;\r\n\t\t\r\n\t\tvar style = {\r\n\t\t\tfont: '18px \"Microsoft YaHei\", sans-serif',\r\n\t\t\ttextColor: '#123456'\r\n\t\t};\r\n\t\tvar pos = {\r\n\t\t\tleftCur: 150,\r\n\t\t\ttop: 50,\r\n\t\t\tseparationSpace: 15,\r\n\t\t\tseparatorWidth: 7,\r\n\t\t\twordWidth: 17,\r\n\r\n\t\t};\r\n\r\n\t\t//构造分隔符(>)polyline对象\r\n\t\tvar line = [[0, 0], [pos.separatorWidth - 1, pos.separatorWidth], [0, pos.separatorWidth * 2]];\r\n\t\tvar polylineLeft = pos.leftCur + (2 * index - 1) * pos.separationSpace + (item.concatString.length ) * pos.wordWidth + (index - 1) * pos.separatorWidth;\r\n\t\tvar\tpolyline = {\r\n                    type: 'polyline',\r\n                    left: polylineLeft,\r\n                    top: pos.top,\r\n                    shape: {\r\n                        points: line\r\n                    },\r\n                    silent: true,\r\n                    bounding: 'all'\r\n                }\r\n\r\n        //构造名称text对象\r\n        var textLeft = pos.leftCur + index * (2 * pos.separationSpace + pos.separatorWidth) + item.concatString.length * pos.wordWidth;\r\n        var text = {\r\n                    type: 'text',\r\n                    left: textLeft,\r\n                    top: pos.top,\r\n                    style: {\r\n                        text: item.name,\r\n                        textAlign: 'center',\r\n                        fill: style.textColor,\r\n                        font: style.font\r\n                    },\r\n                    onclick: function(){\r\n                    \tif(item.adcode != _this.adcode){\r\n                    \t\t_this.adcode = item.adcode;\r\n                    \t\t_this.init();\r\n                    \t}\t\r\n                    }\r\n                }\r\n\r\n        return (index == 0 ? [text] : [polyline, text]);\r\n\t},\r\n\r\n}\r\n\r\n\r\nvar echartOption = {\r\n        tooltip : {\r\n\t        trigger: 'item'\r\n\t    },\r\n        geo: {\r\n        \troam: true,\r\n\t        map: '',\r\n\t        label: {\r\n\t            emphasis: {\r\n\t                show: false\r\n\t            }\r\n\t        },\r\n\t        itemStyle: {\r\n\t            normal: {\r\n\t                areaColor: '#304553',\r\n\t                borderColor: '#fff'\r\n\t            }\r\n\t        },\r\n\t        silent: true\r\n\t    },\r\n\t    visualMap: {\r\n\t        show: false,\r\n\t        min: 80,\r\n\t        max: 500,\r\n\t        inRange: {\r\n\t            colorLightness: [0, 1]\r\n\t        }\r\n\t    },\r\n        series: []\r\n    };\r\n    \r\nvar chart = new GDEcharts({containerId: 'chart-panel', echartOption: echartOption});\r\n\r\n\r\n","html":"","externalScripts":"http://webapi.amap.com/maps?v=1.4.6&key=71b7119ba58b3e113a95951ccf340381,http://webapi.amap.com/ui/1.0/main.js?v=1.0.11,http://echarts.baidu.com/dist/echarts.min.js","updaterUID":"bd-1025214267","theme":"","layout":"","viewCount":10818,"userName":"d***e","commentCount":12,"starCount":23,"isStared":0,"thumbnailURL":"https://www.makeapie.com/ecg-storage/ec_gallery_thumbnail/xBkrfv2nfm.png?v=1532079512806","isCustomThumbnail":0,"builtinTags":["category-work","geo","graphic","series-pie","tooltip","visualMap"],"customTags":["amap","map"],"updaterUserName":"d***e"}}