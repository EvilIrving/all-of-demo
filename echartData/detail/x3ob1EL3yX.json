{"status":0,"data":{"cid":"x3ob1EL3yX","authorUid":"obd-oFbxvYoSWxSLUyDt5qcvCYwk1vh505o","authorUserName":"情***6","title":"地图下钻+数据映射","description":"","latestVersion":2,"alwaysLatest":0,"createTime":"2021-04-26T08:26:39.000Z","lastUpdateTime":"2021-08-16T01:33:12.000Z","auth":2,"uid":"obd-oFbxvYoSWxSLUyDt5qcvCYwk1vh505o","publishedVersion":0,"forkFrom":"-","isSpam":0,"version":2,"parentVersion":1,"echartsVersion":"4.9.0","versionCreateTime":"2021-08-16T01:33:12.000Z","code":"var parentJson = null;\nvar parentInfo = [\n  {\n    cityName: '四川',\n    level: 'city',\n    code: 510000,\n  },\n];\ngetGeoJson(510000);\nvar timeFn = null;\n// 利用高德api获取行政区边界geoJson\n// adcode 行政区code 编号\nfunction getGeoJson(adcode) {\n  AMapUI.loadUI(['geo/DistrictExplorer'], (DistrictExplorer) => {\n    var districtExplorer = new DistrictExplorer();\n    districtExplorer.loadAreaNode(adcode, function (error, areaNode) {\n      if (error) {\n        console.error(error);\n        return;\n      }\n      let Json = areaNode.getSubFeatures();\n      if (Json.length > 0) {\n        parentJson = Json;\n      } else if (Json.length === 0) {\n        Json = parentJson.filter((item) => {\n          if (item.properties.adcode == adcode) {\n            return item;\n          }\n        });\n        if (Json.length === 0) return;\n      }\n      proceData(Json);\n    });\n  });\n}\n\n//处理数据\nfunction proceData(Json) {\n  let mapData = [\n    {\n      name: '甘孜藏族自治州',\n      cityCode: '513300',\n      value: '460',\n    },\n    {\n      name: '乐山市',\n      cityCode: '511100',\n      value: '1372',\n    },\n    {\n      name: '自贡市',\n      cityCode: '510300',\n      value: '851',\n    },\n    {\n      name: '广元市',\n      cityCode: '510800',\n      value: '720',\n    },\n    {\n      name: '眉山市',\n      cityCode: '511400',\n      value: '1139',\n    },\n    {\n      name: '宜宾市',\n      cityCode: '511500',\n      value: '772',\n    },\n    {\n      name: '攀枝花市',\n      cityCode: '510400',\n      value: '8143',\n    },\n    {\n      name: '凉山彝族自治州',\n      cityCode: '513400',\n      value: '723',\n    },\n    {\n      name: '达州市',\n      cityCode: '511700',\n      value: '705',\n    },\n    {\n      name: '雅安市',\n      cityCode: '511800',\n      value: '448',\n    },\n    {\n      name: '泸州市',\n      cityCode: '510500',\n      value: '1194',\n    },\n    {\n      name: '巴中市',\n      cityCode: '511900',\n      value: '560',\n    },\n    {\n      name: '广安市',\n      cityCode: '511600',\n      value: '373',\n    },\n    {\n      name: '成都市',\n      cityCode: '510100',\n      value: '4543',\n    },\n    {\n      name: '内江市',\n      cityCode: '511000',\n      value: '716',\n    },\n    {\n      name: '遂宁市',\n      cityCode: '510900',\n      value: '521',\n    },\n    {\n      name: '德阳市',\n      cityCode: '510600',\n      value: '1075',\n    },\n    {\n      name: '阿坝藏族羌族自治州',\n      lr: '421',\n      cityCode: '513200',\n      value: '285',\n    },\n    {\n      name: '绵阳市',\n      cityCode: '510700',\n      value: '1180',\n    },\n    {\n      name: '资阳市',\n      cityCode: '512000',\n      value: '682',\n    },\n    {\n      name: '南充市',\n      cityCode: '511300',\n      value: '1352',\n    },\n  ];\n  Json.map((item) => {\n    mapData.forEach((ele) => {\n      if (item.properties.adcode == ele.cityCode) {\n        ele.level = item.properties.level;\n      }\n    });\n  });\n  let mapJson = {};\n  //geoJson必须这种格式\n  mapJson.features = Json;\n\n  //去渲染echarts\n  initEcharts(mapData, mapJson);\n}\n\nfunction initEcharts(mapData, mapJson) {\n  let valArr = [];\n  mapData.map(function (i) {\n    valArr.push(i.value);\n  });\n  // 计算数据最大与最小值用于数据映射组件\n  let max = Math.max.apply(null, valArr);\n  let min = Math.min.apply(null, valArr);\n  //注册\n  echarts.registerMap('Map', mapJson);\n\n  //这里加true是为了让地图重新绘制，不然如果你有筛选的时候地图会飞出去\n  myChart.setOption(\n    {\n      backgroundColor: 'rgb(20,28,52)',\n      tooltip: {\n        trigger: 'item',\n      },\n      visualMap: {\n        type: 'piecewise',\n        min: min,\n        max: max,\n        splitNumber: 5,\n        left: 35,\n        bottom: 50,\n        itemWidth: 21,\n        itemHeight: 8,\n        showLabel: false,\n        orient: 'horizontal',\n        text: ['高', '低'],\n        itemGap: 2,\n        textStyle: {\n          color: '#fff',\n        },\n        inRange: '',\n        color: [\n          'rgba(7, 83, 114,0.8)',\n          'rgba(24, 100, 141,0.9)',\n          'rgba(33, 122, 168,0.8)',\n          'rgba(28, 138, 187,0.7)',\n          'rgba(34, 156, 199,0.8)',\n        ],\n        show: true,\n      },\n\n      series: [\n        {\n          name: '地图',\n          type: 'map',\n          map: 'Map',\n          roam: true, //是否可缩放\n          zoom: 1, //缩放比例\n          aspectScale: 0.9, //长宽比0.75\n          data: mapData,\n          itemStyle: {\n            normal: {\n              show: true,\n              areaColor: '#2E98CA',\n              borderColor: 'rgb(185, 220, 227)',\n              borderWidth: '1',\n            },\n          },\n          label: {\n            normal: {\n              show: true, //显示省份标签\n              textStyle: {\n                color: 'rgb(249, 249, 249)', //省份标签字体颜色\n                fontSize: 12,\n              },\n            },\n            emphasis: {\n              //对应的鼠标悬浮效果\n              show: true,\n              textStyle: {\n                color: '#000',\n              },\n            },\n          },\n        },\n      ],\n    },\n    true\n  );\n  // 单击下钻\n}\n\n//echarts点击事件\nmyChart.on('click', (params) => {\n  clearTimeout(timeFn);\n  timeFn = setTimeout(function () {\n    // 无下级地图数据时不下钻\n    if (!params.value) {\n      alert('暂无数据');\n      return;\n    }\n    //如果当前是最后一级，那就直接return\n    if (parentInfo[parentInfo.length - 1].code == params.data.cityCode) {\n      return;\n    }\n    let data = params.data;\n    parentInfo.push({\n      cityName: data.name,\n      level: data.level,\n      code: data.cityCode,\n    });\n    getGeoJson(data.cityCode);\n  }, 250);\n});\n\n// 绑定双击事件，返回上级地图\nmyChart.on('dblclick', function (params) {\n  clearTimeout(timeFn);\n  if (parentInfo.length < 1) {\n    return;\n  }\n  if (parentInfo.length === 1) {\n    getGeoJson(parentInfo[parentInfo.length - 1].code);\n    return;\n  }\n  parentInfo.pop();\n  getGeoJson(parentInfo[parentInfo.length - 1].code);\n});\n","html":"","externalScripts":"https://webapi.amap.com/maps?v=1.3&key=d5082f6c0dda55d9966c2e3ad7d37af3&plugin=AMap.DistrictSearch,https://webapi.amap.com/ui/1.0/main.js","updaterUID":"obd-oFbxvYoSWxSLUyDt5qcvCYwk1vh505o","theme":"","layout":"","viewCount":0,"userName":"情***6","commentCount":0,"starCount":4,"isStared":0,"thumbnailURL":"https://www.makeapie.com/ecg-storage/ec_gallery_thumbnail/x3ob1EL3yX.png?v=1629077592819","isCustomThumbnail":0,"builtinTags":["category-work","series-map","tooltip","visualMap"],"customTags":[],"updaterUserName":"情***6"}}