{"status":0,"data":{"cid":"xH1Vpz2CHm","authorUid":"bd-3778831175","authorUserName":"m***i","title":"陆家嘴 区域道路和房屋可视化","description":"陆家嘴 区域道路和房屋可视化","latestVersion":4,"alwaysLatest":1,"createTime":"2018-08-13T07:26:51.000Z","lastUpdateTime":"2018-08-13T07:26:51.000Z","auth":2,"uid":"bd-3778831175","publishedVersion":0,"forkFrom":"-","isSpam":0,"version":4,"parentVersion":3,"echartsVersion":"4.2.0","versionCreateTime":"2019-01-09T11:23:32.000Z","code":"var uploadedDataURL_Road = \"/asset/get/s/data-1534143589600-SJRPnoAHQ.json\";\n\nvar uploadedDataURL = \"/asset/get/s/data-1534124434928-H1s9ZDCHm.png\";\n\nvar urls = [\n    '/asset/get/s/data-1534122453627-Sk0AFUAS7.json',\n    '/asset/get/s/data-1534122457941-SyzJ5LRrm.json',\n    '/asset/get/s/data-1534122460460-Sy4ycIRrm.json',\n    '/asset/get/s/data-1534122464227-SyO19LASQ.json',\n    '/asset/get/s/data-1534122469424-H1T1cIAHm.json',\n    '/asset/get/s/data-1534122472873-r1bxqLCrm.json',\n    '/asset/get/s/data-1534122475403-rkXe9I0B7.json',\n    '/asset/get/s/data-1534122480993-Byte9UABm.json',\n    '/asset/get/s/data-1534122485491-Sk6ecICBQ.json',\n    '/asset/get/s/data-1534122489312-SJWbqIRSX.json',\n    '/asset/get/s/data-1534122493485-SkSZ5L0SQ.json',\n    '/asset/get/s/data-1534122497610-rJq-qU0H7.json',\n    '/asset/get/s/data-1534122500830-H16ZcLRSQ.json',\n    '/asset/get/s/data-1534122505132-Hk-M980HX.json',\n    '/asset/get/s/data-1534122575649-Bku8qI0rm.json',\n    '/asset/get/s/data-1534122579059-SJiIqUCrQ.json',\n    '/asset/get/s/data-1534122582576-SyyvqURSm.json',\n    '/asset/get/s/data-1534123103827-Hyuvn8ABX.json',\n    '/asset/get/s/data-1534123105869-rJqP2IASX.json',\n    '/asset/get/s/data-1534123108102-rynD3IAH7.json',\n    '/asset/get/s/data-1534123110483-Hk0DnIRSm.json',\n    '/asset/get/s/data-1534123112641-Sy-OnUAS7.json',\n    '/asset/get/s/data-1534123114663-H1XdnIASQ.json',\n    '/asset/get/s/data-1534123117335-S1Su3U0rm.json',\n    '/asset/get/s/data-1534123119678-ryuu2U0BX.json',\n    '/asset/get/s/data-1534123122201-r19_2LRrX.json',\n    '/asset/get/s/data-1534123124560-rkpOnL0HX.json',\n    '/asset/get/s/data-1534123127438-rJ1Yh8ASQ.json',\n    '/asset/get/s/data-1534123130178-HkMY2URH7.json',\n    '/asset/get/s/data-1534123132763-SkBtnUCr7.json',\n    '/asset/get/s/data-1534123135252-BJvKnLCB7.json',\n    '/asset/get/s/data-1534123147274-r1m52ICSm.json',\n    '/asset/get/s/data-1534123149452-SJB938Crm.json',\n    '/asset/get/s/data-1534123151998-rkO9h8RSm.json',\n    '/asset/get/s/data-1534123154271-rJ99h8CS7.json',\n    '/asset/get/s/data-1534123156635-ByT53ICBm.json',\n    '/asset/get/s/data-1534123158829-rk1in80Sm.json',\n    '/asset/get/s/data-1534123165450-rJHj2LRH7.json',\n    '/asset/get/s/data-1534123169857-ry9s3I0BQ.json',\n    '/asset/get/s/data-1534123172167-BJ3i38CHQ.json',\n    '/asset/get/s/data-1534123178732-SymnnIRHQ.json',\n    '/asset/get/s/data-1534123181402-r1HnhLRS7.json',\n    '/asset/get/s/data-1534123184197-ByO2nLRr7.json',\n    '/asset/get/s/data-1534123187746-Hyh3nUAr7.json',\n    '/asset/get/s/data-1534123191298-Bykp3URSQ.json',\n    '/asset/get/s/data-1534123210480-ryzC3U0H7.json',\n    '/asset/get/s/data-1534123213741-S180h8AHm.json',\n    '/asset/get/s/data-1534123216424-BydCn80HX.json',\n    '/asset/get/s/data-1534123218675-HJsChURBX.json',\n    '/asset/get/s/data-1534123229545-SyU1T8ABX.json',\n    '/asset/get/s/data-1534123232244-BkdJaUCrX.json',\n    '/asset/get/s/data-1534123234858-H1sJ6I0Hm.json',\n    '/asset/get/s/data-1534123237173-rk6kaLCB7.json',\n    '/asset/get/s/data-1534123239663-HkxlpLABm.json',\n    '/asset/get/s/data-1534123242280-HkGgaU0Hm.json',\n    '/asset/get/s/data-1534123244901-HJSepUCHm.json',\n    '/asset/get/s/data-1534123248392-rkOg68CrX.json',\n    '/asset/get/s/data-1534123250899-SJjgpL0H7.json',\n    '/asset/get/s/data-1534123254292-rkAlaUArm.json',\n    '/asset/get/s/data-1534123258486-ryz-6LRBX.json',\n    '/asset/get/s/data-1534123282702-B1iG6I0Bm.json',\n    '/asset/get/s/data-1534123284897-H1aGpICSX.json',\n    '/asset/get/s/data-1534123287886-HkgmTL0BX.json',\n    '/asset/get/s/data-1534123290691-rJQXaUAHm.json',\n    '/asset/get/s/data-1534123293635-ryLXa8ArQ.json',\n    '/asset/get/s/data-1534123296625-rkFQpIRHQ.json',\n    '/asset/get/s/data-1534123300422-S137pLCSm.json',\n    '/asset/get/s/data-1534123304645-Sy-ETI0Sm.json',\n    '/asset/get/s/data-1534123308760-BySVa8CSm.json',\n    '/asset/get/s/data-1534123319900-BJeBpL0SX.json',\n    '/asset/get/s/data-1534123323017-H1mSTLRSQ.json',\n    '/asset/get/s/data-1534123325915-rk8STLAHQ.json',\n    '/asset/get/s/data-1534123337250-Hk-LaLCSQ.json',\n    '/asset/get/s/data-1534123351737-BkgvpLCSX.json',\n    '/asset/get/s/data-1534123353938-HyMw68CS7.json',\n    '/asset/get/s/data-1534123356243-ry4PTLRrX.json',\n    '/asset/get/s/data-1534123358565-HJvvpIASX.json',\n    '/asset/get/s/data-1534123360969-BJKPTL0Hm.json',\n    '/asset/get/s/data-1534123363418-BJoD6LCHm.json',\n    '/asset/get/s/data-1534123365741-HJRP6U0Sm.json',\n    '/asset/get/s/data-1534123368303-r1l_aLABm.json',\n    '/asset/get/s/data-1534123371112-H1m_TL0rQ.json',\n    '/asset/get/s/data-1534123373639-rk8dpICHQ.json',\n    '/asset/get/s/data-1534123375996-HJdOpLCSm.json',\n    '/asset/get/s/data-1534123378375-HJ5_aL0BQ.json',\n    '/asset/get/s/data-1534123381458-rkTdaUABQ.json',\n    '/asset/get/s/data-1534123383791-H1gY6LASm.json',\n    '/asset/get/s/data-1534123386608-r1Qta8AHX.json',\n    '/asset/get/s/data-1534123389592-BkLFT80Sm.json',\n    '/asset/get/s/data-1534123392752-ByYFaLASQ.json',\n    '/asset/get/s/data-1534123404802-H1H9p8ASQ.json',\n    '/asset/get/s/data-1534123406805-HJwqTU0Bm.json',\n    '/asset/get/s/data-1534123409216-rkYcTURB7.json',\n    '/asset/get/s/data-1534123411440-rkoqT8AHX.json',\n    '/asset/get/s/data-1534123413486-HJ69pU0SX.json',\n    '/asset/get/s/data-1534123415782-rygoTI0Hm.json',\n    '/asset/get/s/data-1534123418179-SJMipICBm.json',\n    '/asset/get/s/data-1534123420543-rJrj6LRBQ.json',\n    '/asset/get/s/data-1534123422759-rkDiaUASQ.json',\n    '/asset/get/s/data-1534123425409-H1FsTLRB7.json',\n    '/asset/get/s/data-1534123427825-rk2o680rQ.json',\n    '/asset/get/s/data-1534123430410-ryCsTUCr7.json',\n    '/asset/get/s/data-1534123432881-S1Z2pUCBQ.json',\n    '/asset/get/s/data-1534123435520-BkNnp80SQ.json',\n    '/asset/get/s/data-1534123439893-By_3TIABm.json',\n    '/asset/get/s/data-1534123443374-HJi3aURBm.json',\n    '/asset/get/s/data-1534123446355-HyAh6L0rm.json',\n    '/asset/get/s/data-1534123449835-ByM6TICHm.json',\n    '/asset/get/s/data-1534123452692-HJrT6LASm.json',\n    '/asset/get/s/data-1534123455539-Sy_6680SX.json',\n    '/asset/get/s/data-1534123466997-S1mApURBm.json',\n    '/asset/get/s/data-1534123469207-rJHRaIAHm.json',\n    '/asset/get/s/data-1534123471315-SyDATUArQ.json',\n    '/asset/get/s/data-1534123474095-B15Cp8RrX.json',\n    '/asset/get/s/data-1534123476663-Hyp0TIRrX.json',\n    '/asset/get/s/data-1534123479220-BJJ10LABQ.json',\n    '/asset/get/s/data-1534123481859-SyzkALAHX.json',\n    '/asset/get/s/data-1534123484201-B1Ek0UABm.json',\n    '/asset/get/s/data-1534123486539-rJwy08RHX.json',\n    '/asset/get/s/data-1534123488873-SyKJAURrX.json',\n    '/asset/get/s/data-1534123491450-Hks10IRHm.json',\n    '/asset/get/s/data-1534123494077-S10108RSQ.json',\n    '/asset/get/s/data-1534123496303-Hkgxg08CHX.json',\n    '/asset/get/s/data-1534123498919-By7eRLAH7.json',\n    '/asset/get/s/data-1534123504469-Sk_xC80S7.json',\n    '/asset/get/s/data-1534123508397-B1ne0IRB7.json',\n    '/asset/get/s/data-1534123511120-SyJbC8CrX.json',\n    '/asset/get/s/data-1534123514840-Sk7ZCICBm.json',\n    '/asset/get/s/data-1534123517358-SyBZ0IRS7.json'\n];\n\n\nvar len = urls.length;\nvar index = 0;\nvar idMap = {};\n\nfunction getRoads(callback) {\n    $.getJSON(uploadedDataURL_Road, function(roadJson) {\n        console.log(roadJson)\n        var linesData = formatRoadData(roadJson);\n        callback(linesData);\n    });\n}\n\n\n\nfunction formatRoadData(shanghairoads) {\n    var roads = shanghairoads;\n    var roadList = [];\n    roads.forEach(element => {\n        var roadArray = element.split(';');\n        var lnglats = [];\n        roadArray.forEach(ll => {\n            let lnglat = ll.split(',');\n            lnglat = [parseFloat(lnglat[0]), parseFloat(lnglat[1])];\n            let pt = turf.point(lnglat);\n            let converted = turf.toWgs84(pt);\n            lnglats.push(converted.geometry.coordinates);\n        });\n        roadList.push({\n            coords: lnglats\n        });\n    });\n    return roadList;\n\n}\n\nfunction getJson(idx) {\n    var url = urls[idx];\n    $.getJSON(url, function(buildingsGeoJSON) {\n        var builds = [];\n        if (buildingsGeoJSON.features) {\n            buildingsGeoJSON = buildingsGeoJSON.features;\n            builds = buildingsGeoJSON.map(function(feature) {\n                //   feature.properties.name=feature.id;\n                // console.log(feature.properties)\n                return feature;\n            })\n        } else {\n            builds = buildingsGeoJSON.map(function(feature) {\n                return {\n                    \"type\": \"Feature\",\n                    \"properties\": {\n                        \"name\": Math.random().toString(),\n                        \"height\": feature.height\n                    },\n                    \"geometry\": {\n                        \"type\": \"Polygon\",\n                        \"coordinates\": [feature.polygon]\n                    }\n                }\n            })\n        }\n        var buildsNew = [];\n        builds.forEach(element => {\n            let id = element.id;\n            if (!idMap[id]) {\n                buildsNew.push(element);\n                idMap[id] = id;\n            }\n\n        });\n        var regionsData = buildsNew.map(function(feature) {\n            let f = {\n                name: feature.properties.name || feature.properties.id,\n                value: Math.random() * 1,\n                height: feature.properties.height * 2 || feature.properties.levels * 8,\n                coords: feature.geometry.coordinates,\n            };\n            if (f.height < 30 || isNaN(f.height)) f.height = 30;\n            return f;\n        });\n        index++;\n        if (index < len) {\n            myChart.appendData({\n                seriesIndex: 0,\n                data: regionsData\n            });\n            getJson(index);\n        } else {\n            //initCharts(index);\n        }\n    })\n\n}\n\nfunction initCharts(linesData) {\n    myChart.setOption({\n        title: {\n            text: '陆家嘴',\n            textStyle: {\n                color: '#fff',\n                fontSize: 45,\n                align: 'center'\n            }\n        },\n        maptalks3D: {\n            zoom: 6,\n            center: [121.49342415576655, 31.24042154361959],\n            pitch: 55,\n            bearing: 0,\n            urlTemplate: 'http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',\n            postEffect: {\n                enable: true,\n                FXAA: {\n                    enable: true\n                }\n            },\n            light: {\n                main: {\n                    intensity: 1,\n                    shadow: false,\n                    shadowQuality: 'high'\n                },\n                ambient: {\n                    intensity: 0.\n                },\n                ambientCubemap: {\n                    texture: '/asset/get/s/data-1491838644249-ry33I7YTe.hdr',\n                    exposure: 1,\n                    diffuseIntensity: 0.5,\n                    specularIntensity: 2\n                }\n            }\n        },\n        series: [{\n                type: 'polygons3D',\n                coordinateSystem: 'maptalks3D',\n                // multiPolygon: true,\n                // map: 'buildings',\n                data: [], //buildsData,\n                shading: 'realistic',\n                instancing: true,\n                silent: true,\n                realisticMaterial: {\n                    metalness: 1,\n                    roughness: 0.4,\n                    textureTiling: 35,\n                    detailTexture: uploadedDataURL\n                }\n            },\n            {\n                type: 'lines3D',\n                coordinateSystem: 'maptalks3D',\n                effect: {\n                    show: true,\n                    constantSpeed: 0.001,\n                    trailWidth: 5,\n                    trailLength: 0.5,\n                    trailOpacity: 1,\n                    spotIntensity: 10\n                },\n                blendMode: 'lighter',\n                lineStyle: {\n                    color: '#0991A9',\n                    opacity: 0.1\n\n                },\n                polyline: true,\n                data: linesData\n            }\n        ]\n    });\n    var map = myChart.getModel().getComponent('maptalks3D').getMaptalks();\n    map.on('click', function(e) {\n        console.log(map.getView());\n    })\n    map.animateTo({\n        zoom: 16,\n        center: [121.49342415576655, 31.24042154361959],\n        pitch: 55,\n        bearing: 0\n    }, {\n        duration: 5000\n    })\n}\nmyChart.showLoading();\ngetRoads(function(linesData) {\n    myChart.hideLoading();\n    initCharts(linesData);\n    getJson(0)\n});\n\n\nwindow.addEventListener('resize', function() {\n    myChart.resize();\n});","html":"","externalScripts":"https://deyihu.github.io/src/lib/echarts-gl.1.1.3.js?tdsourcetag=s_pctim_aiomsg,https://cdn.jsdelivr.net/npm/maptalks@0.40.1/dist/maptalks.min.js,https://cdn.bootcss.com/Turf.js/5.1.6/turf.min.js","updaterUID":"bd-3778831175","theme":"","layout":"","viewCount":836,"userName":"m***i","commentCount":1,"starCount":2,"isStared":0,"thumbnailURL":"https://www.makeapie.com/ecg-storage/ec_gallery_thumbnail/xH1Vpz2CHm.png?v=1534145213041","isCustomThumbnail":1,"builtinTags":["category-work","maptalks3D","series-lines3D","series-polygons3D","title"],"customTags":[],"updaterUserName":"m***i"}}