{"status":0,"data":{"cid":"xO-7sB0Llr","authorUid":"obd-oCocCvbok4_AIx-uZQAfR94FK_sLd3f","authorUserName":"g***j","title":"地图钻取","description":"","latestVersion":1,"alwaysLatest":1,"createTime":"2020-10-12T06:38:49.000Z","lastUpdateTime":"2020-10-12T06:38:49.000Z","auth":2,"uid":"obd-oCocCvbok4_AIx-uZQAfR94FK_sLd3f","publishedVersion":0,"forkFrom":"-","isSpam":0,"version":1,"parentVersion":-1,"echartsVersion":"4.8.0","versionCreateTime":"2020-10-12T06:38:49.000Z","code":"/**\n *    地图2.0升级版 ，美化了页面样式，添加时间控件   \n *    显示南海诸岛    下钻的标题样式修改\n *    设置geoIndex 和  visualMap 里面的seriesIndex  就可以让地图和点同时存在\n *    这个时候地图颜色的配置就在 geo里面配置了而不是  series里面\n *    借鉴了一些社区大佬的作品   \n *    后续可能还要加的功能  ：1. 右边的柱状图\n *                            2. 点击下钻左上角显示 中国->湖北->武汉  类似于这种\n */\n\n\n$('<div class=\"back\">返 回</div>').appendTo(\n    $('#chart-panel')\n);\n\n$('.back').css({\n    'position': 'absolute',\n    'left': '25px',\n    'top': '25px',\n    'color': 'rgb(179, 239, 255)',\n    'font-size': '16px',\n    cursor: 'pointer',\n    'z-index': '100'\n})\n\n$('.back').click(function() {\n    if (parentInfo.length === 1) {\n        return;\n    }\n    parentInfo.pop()\n    getGeoJson(parentInfo[parentInfo.length - 1].code)\n})\n\n\n\nvar geoJson = {\n    features: []\n}\n\nvar parentInfo = [{\n    cityName: '全国',\n    level: 'china',\n    code: 100000\n}]\n\nvar timeTitle = ['2016']\ngetGeoJson(100000)\n\n\nfunction getGeoJson(adcode) {\n    AMapUI.loadUI(['geo/DistrictExplorer'], DistrictExplorer => {\n        var districtExplorer = new DistrictExplorer()\n        districtExplorer.loadAreaNode(adcode, function(error, areaNode) {\n            if (error) {\n                console.error(error);\n                return;\n            }\n            let Json = areaNode.getSubFeatures()\n            if (Json.length > 0) {\n                geoJson.features = Json\n            } else if (Json.length === 0) {\n                geoJson.features = geoJson.features.filter(item => item.properties.adcode == adcode)\n                if (geoJson.features.length === 0) return\n            }\n            getMapData()\n        });\n    })\n}\n\n//获取数据    拼接，获取近五年的数据\nfunction getMapData() {\n    let mapData = {},\n        pointData = {},\n        sum = {}\n    for (let i = 0; i < timeTitle.length; i++) {\n        mapData[timeTitle[i]] = []\n        pointData[timeTitle[i]] = []\n        sum[timeTitle[i]] = 0\n        for (let j = 0; j < geoJson.features.length; j++) {\n            let value = Math.random() * 3000\n            mapData[timeTitle[i]].push({\n                name: geoJson.features[j].properties.name,\n                value: value,\n                level: geoJson.features[j].properties.level,\n                cityCode: geoJson.features[j].properties.adcode\n            })\n            pointData[timeTitle[i]].push({\n                name: geoJson.features[j].properties.name,\n                value: [geoJson.features[j].properties.center[0], geoJson.features[j].properties.center[1], value],\n                cityCode: geoJson.features[j].properties.adcode\n            })\n            sum[timeTitle[i]] += value\n        }\n        mapData[timeTitle[i]] = mapData[timeTitle[i]].sort(function(a, b) {\n            return b.value - a.value\n        });\n    }\n    initEchartMap(mapData, sum, pointData)\n}\n\n\n//渲染echarts\nfunction initEchartMap(mapData, sum, pointData) {\n\n    //这里做个切换，全国的时候才显示南海诸岛  只有当注册的名字为china的时候才会显示南海诸岛\n    if (parentInfo.length === 1) {\n        echarts.registerMap('china', geoJson); //注册\n    } else {\n        echarts.registerMap('map', geoJson); //注册\n    }\n\n    var option = {\n        timeline: {\n            // data: timeTitle,\n            // axisType: 'category',\n            // autoPlay: true,\n            // playInterval: 3000,\n            // left: '10%',\n            // right: '10%',\n            // bottom: '3%',\n            // width: '80%',\n            // label: {\n            //     normal: {\n            //         textStyle: {\n            //             color: 'rgb(179, 239, 255)'\n            //         }\n            //     },\n            //     emphasis: {\n            //         textStyle: {\n            //             color: '#fff'\n            //         }\n            //     }\n            // },\n            // symbolSize: 10,\n            // lineStyle: {\n            //     color: '#8df4f4'\n            // },\n            // checkpointStyle: {\n            //     borderColor: '#8df4f4',\n            //     color: '#53D9FF',\n            //     borderWidth: 2,\n            // },\n            // controlStyle: {\n            //     showNextBtn: true,\n            //     showPrevBtn: true,\n            //     normal: {\n            //         color: '#53D9FF',\n            //         borderColor: '#53D9FF'\n            //     },\n            //     emphasis: {\n            //         color: 'rgb(58,115,192)',\n            //         borderColor: 'rgb(58,115,192)'\n            //     }\n            // },\n\n        },\n        baseOption: {\n            animation: true,\n            animationDuration: 1000,\n            animationEasing: 'cubicInOut',\n            animationDurationUpdate: 1000,\n            animationEasingUpdate: 'cubicInOut',\n            tooltip: {\n                trigger: \"item\",\n            },\n            toolbox: {\n                feature: {\n                    restore: {\n                        show: false\n                    },\n                    dataView: {\n                        optionToContent: function(opt) {\n                            let series = opt.series[0].data //折线图数据\n                            let tdHeads = '<th  style=\"padding: 0 20px\">所在地区</th><th style=\"padding: 0 20px\">销售额</th>' //表头\n                            let tdBodys = '' //数据\n                            let table = `<table border=\"1\" style=\"margin-left:20px;border-collapse:collapse;font-size:14px;text-align:left;\"><tbody><tr>${tdHeads} </tr>`\n                            for (let i = 0; i < series.length; i++) {\n                                table += `<tr>\n                              <td style=\"padding: 0 50px\">${series[i].name}</td>\n                              <td style=\"padding: 0 50px\">${series[i].value.toFixed(2)}万</td>\n                              </tr>`\n                            }\n                            table += '</tbody></table>'\n                            return table\n                        }\n                    },\n                    saveAsImage: {\n                        name: parentInfo[parentInfo.length - 1].cityName + '销售额统计图'\n                    },\n                    dataZoom: {\n                        show: false\n                    },\n                    magicType: {\n                        show: false\n                    }\n                },\n                iconStyle: {\n                    normal: {\n                        borderColor: '#1990DA'\n                    }\n                },\n                top: 15,\n                right: 35\n            },\n            geo: {\n                map: parentInfo.length === 1 ? 'china' : 'map',\n                zoom: 1.1,\n                roam: true,\n                tooltip: {\n                    trigger: 'item',\n                    formatter: (p) => {\n                        let val = p.value[2];\n                        if (window.isNaN(val)) {\n                            val = 0;\n                        }\n                        let txtCon =\n                            \"<div style='text-align:left'>\" + p.name + \":<br />销售额：\" + val.toFixed(2) + '万</div>';\n                        return txtCon;\n                    }\n                },\n                label: {\n                    normal: {\n                        show: true,\n                        color: \"rgb(249, 249, 249)\", //省份标签字体颜色\n                        formatter: p => {\n                            switch (p.name) {\n                                case '内蒙古自治区':\n                                    p.name = \"内蒙古\"\n                                    break;\n                                case '西藏自治区':\n                                    p.name = \"西藏\"\n                                    break;\n                                case '新疆维吾尔自治区':\n                                    p.name = \"新疆\"\n                                    break;\n                                case '宁夏回族自治区':\n                                    p.name = \"宁夏\"\n                                    break;\n                                case '广西壮族自治区':\n                                    p.name = \"广西\"\n                                    break;\n                                case '香港特别行政区':\n                                    p.name = \"香港\"\n                                    break;\n                                case '澳门特别行政区':\n                                    p.name = \"澳门\"\n                                    break;\n                                default:\n                                    break;\n                            }\n                            return p.name;\n                        }\n                    },\n                    emphasis: {\n                        show: true,\n                        color: '#f75a00',\n                    }\n                },\n                itemStyle: {\n                    normal: {\n                        areaColor: '#24CFF4',\n                        borderColor: '#53D9FF',\n                        borderWidth: 1.3,\n                        shadowBlur: 15,\n                        shadowColor: 'rgb(58,115,192)',\n                        shadowOffsetX: 7,\n                        shadowOffsetY: 6,\n                    },\n                    emphasis: {\n                        areaColor: '#8dd7fc',\n                        borderWidth: 1.6,\n                        shadowBlur: 25,\n                    }\n\n                },\n            },\n\n        },\n        options: []\n    }\n    timeTitle.forEach(item => {\n        var min = mapData[item][mapData[item].length - 1].value\n        var max = mapData[item][0].value\n        if (mapData[item].length === 1) {\n            min = 0\n        }\n        option.options.push({\n            backgroundColor: '#012248',\n            title: [{\n                    left: 'center',\n                    top: 10,\n                    text: item + '年' + parentInfo[parentInfo.length - 1].cityName + '销售额统计图(可点击)',\n                    textStyle: {\n                        color: 'rgb(179, 239, 255)',\n                        fontSize: 16\n                    },\n                },\n                {\n                    text: \"年度销售总额：\" + sum[item].toFixed(2) + '万',\n                    left: 'center',\n                    top: '6.5%',\n                    textStyle: {\n                        color: '#FFAC50',\n                        fontSize: 26\n                    }\n                }\n            ],\n            visualMap: {\n                min: min,\n                max: max,\n                left: '3%',\n                bottom: '5%',\n                calculable: true,\n                seriesIndex: [0],\n                inRange: {\n                    color: ['#24CFF4', '#2E98CA', '#1E62AC']\n                },\n                textStyle: {\n                    color: '#24CFF4'\n                }\n            },\n            series: [{\n                    name: item + '销售额度',\n                    type: 'map',\n                    geoIndex: 0,\n                    map: parentInfo.length === 1 ? 'china' : 'map',\n                    roam: true,\n                    zoom: 1.3,\n                    tooltip: {\n                        trigger: \"item\",\n                        formatter: p => {\n                            let val = p.value;\n                            if (p.name == '南海诸岛') return\n                            if (window.isNaN(val)) {\n                                val = 0;\n                            }\n                            let txtCon =\n                                \"<div style='text-align:left'>\" + p.name + \":<br />销售额：\" + val.toFixed(2) + '万</div>';\n                            return txtCon;\n                        }\n                    },\n                    label: {\n                        normal: {\n                            show: false,\n                        },\n                        emphasis: {\n                            show: false,\n                        }\n                    },\n                    data: mapData[item],\n\n                }, {\n                    name: '散点',\n                    type: 'effectScatter',\n                    coordinateSystem: 'geo',\n                    rippleEffect: {\n                        brushType: 'fill'\n                    },\n                    itemStyle: {\n                        normal: {\n                            color: '#F4E925',\n                            shadowBlur: 10,\n                            shadowColor: '#333'\n                        }\n                    },\n                    data: pointData[item],\n                    // symbolSize: 8,\n                    symbolSize: function(val) {\n                        let value = val[2]\n                        if (value == max) {\n                            return 11\n                        }\n                        return 10\n                    },\n                    showEffectOn: 'render', //加载完毕显示特效\n                },\n\n            ]\n        })\n    })\n\n    myChart.setOption(option, true)\n\n\n    //点击前解绑，防止点击事件触发多次\n    myChart.off('click');\n    myChart.on('click', echartsMapClick);\n}\n\n//echarts点击事件\nfunction echartsMapClick(params) {\n    if (!params.data) {\n        return\n    } else {\n        //如果当前是最后一级，那就直接return\n        if (parentInfo[parentInfo.length - 1].code == params.data.cityCode) {\n            return\n        }\n        let data = params.data\n        parentInfo.push({\n            cityName: data.name,\n            level: data.level,\n            code: data.cityCode\n        })\n        getGeoJson(data.cityCode)\n    }\n}","html":"","externalScripts":"https://webapi.amap.com/maps?v=1.3&key=73cddabc2173e0166a622f4483d3592a&plugin=AMap.DistrictSearch,https://webapi.amap.com/maps?v=1.3&key=73cddabc2173e0166a622f4483d3592a,https://webapi.amap.com/ui/1.0/main.js,https://echarts.baidu.com/resource/echarts-gl-latest/dist/echarts-gl.min.js","updaterUID":"obd-oCocCvbok4_AIx-uZQAfR94FK_sLd3f","theme":"","layout":"","viewCount":2318,"userName":"g***j","commentCount":1,"starCount":22,"isStared":0,"thumbnailURL":"https://www.makeapie.com/ecg-storage/ec_gallery_thumbnail/xO-7sB0Llr.png?v=1602484729961","isCustomThumbnail":0,"builtinTags":["category-work","geo","series-effectScatter","series-map","timeline","title","toolbox","tooltip","visualMap"],"customTags":[],"updaterUserName":"g***j"}}