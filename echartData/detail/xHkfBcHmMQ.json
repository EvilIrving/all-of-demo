{"status":0,"data":{"cid":"xHkfBcHmMQ","authorUid":"bd-3778831175","authorUserName":"m***i","title":"Music Visualization By bar3D on Map","description":"在地图上进行音乐的可视化","latestVersion":4,"alwaysLatest":1,"createTime":"2018-06-29T05:57:14.000Z","lastUpdateTime":"2018-06-29T05:57:14.000Z","auth":2,"uid":"bd-3778831175","publishedVersion":0,"forkFrom":"-","isSpam":0,"version":4,"parentVersion":3,"echartsVersion":"4.2.0","versionCreateTime":"2019-01-09T10:39:12.000Z","code":"      const minLng = 120.9337719797137;\r\n      const minLat = 30.85610622801201;\r\n      const maxLat = 31.452846278953274;\r\n      const maxLng = 121.69631352726838;\r\n\r\n      const scale = 8000;\r\n\r\n      const averageLng = (maxLng - minLng) / 50;\r\n      const averageLat = (maxLat - minLat) / 50;\r\n\r\n\r\n      var UPDATE_DURATION = 100;\r\n\r\n      window.AudioContext = window.AudioContext || window.webkitAudioContext;\r\n\r\n      var audioContext = new AudioContext();\r\n\r\n      var oReq = new XMLHttpRequest();\r\n      oReq.open('GET', '/asset/get/s/data-1493350085456-S1p6LNlyZ.mp3', true);\r\n      oReq.responseType = 'arraybuffer';\r\n\r\n      oReq.onload = function(e) {\r\n          audioContext.decodeAudioData(oReq.response, initVisualizer);\r\n      };\r\n      oReq.send();\r\n\r\n      function initVisualizer(audioBuffer) {\r\n          inited = true;\r\n\r\n          var source = audioContext.createBufferSource();\r\n          source.buffer = audioBuffer;\r\n\r\n          // Must invoked right after click event\r\n          if (source.noteOn) {\r\n              source.noteOn(0);\r\n          } else {\r\n              source.start(0);\r\n          }\r\n\r\n          var analyzer = audioContext.createAnalyser();\r\n          var gainNode = audioContext.createGain();\r\n          analyzer.fftSize = 4096;\r\n\r\n          gainNode.gain.value = 1;\r\n          source.connect(gainNode);\r\n          gainNode.connect(analyzer);\r\n          analyzer.connect(audioContext.destination);\r\n\r\n          var frequencyBinCount = analyzer.frequencyBinCount;\r\n          var dataArray = new Uint8Array(frequencyBinCount);\r\n\r\n\r\n          var beta = 0;\r\n          // copy   from http://echarts.baidu.com/examples/editor.html?c=bar3d-music-visualization&gl=1\r\n          function update() {\r\n              analyzer.getByteFrequencyData(dataArray);\r\n\r\n              var item = [];\r\n              var size = 50;\r\n              var dataProvider = [];\r\n\r\n              for (var i = 0; i < size * size; i++) {\r\n                  var x = i % size;\r\n                  var y = Math.floor(i / size);\r\n                  var dx = x - size / 2;\r\n                  var dy = y - size / 2;\r\n\r\n                  var angle = Math.atan2(dy, dx);\r\n                  if (angle < 0) {\r\n                      angle = Math.PI * 2 + angle;\r\n                  }\r\n                  var dist = Math.sqrt(dx * dx + dy * dy);\r\n                  var idx = Math.min(\r\n                      frequencyBinCount - 1, Math.round(angle / Math.PI / 2 * 60 + dist * 60) + 100\r\n                  );\r\n\r\n                  var val = Math.pow(dataArray[idx] / 100, 3);\r\n                  dataProvider.push([x, y, Math.max(val, 0.1)]);\r\n              }\r\n              let musdata = [];\r\n              for (let i = 0; i < dataProvider.length; i++) {\r\n                  let d = dataProvider[i];\r\n                  let x = d[0],\r\n                      y = d[1],\r\n                      z = d[2];\r\n                  let lng = minLng + x * averageLng;\r\n                  let lat = minLat + y * averageLat;\r\n                  let height = z * scale;\r\n                  if (height < 2000) continue;\r\n                  musdata.push({\r\n                      name: Math.random() * 10000,\r\n                      value: [lng, lat, height]\r\n                  })\r\n              }\r\n\r\n              myChart.setOption({\r\n                  series: [{\r\n                      data: musdata\r\n                  }]\r\n              });\r\n              beta += 2;\r\n\r\n              setTimeout(update, UPDATE_DURATION);\r\n          };\r\n\r\n          update();\r\n      }\r\n\r\n      option = {\r\n          tooltip: {},\r\n          visualMap: {\r\n              show: false,\r\n              min: 0.1 * scale,\r\n              max: 4 * scale,\r\n              inRange: {\r\n                  color: ['#010103', '#2f490c', '#b0b70f', '#fdff44', '#fff']\r\n              }\r\n          },\r\n          maptalks3D: {\r\n              urlTemplate: 'http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',\r\n              center: [121.4693, 31.123070],\r\n              zoom: 11,\r\n              pitch: 60,\r\n              // boxHeight: 30,\r\n              environment: '#000',\r\n              viewControl: {\r\n                  distance: 100\r\n              },\r\n              postEffect: {\r\n                  enable: true,\r\n                  FXAA: {\r\n                      enable: true\r\n                  }\r\n              },\r\n              light: {\r\n                  main: {\r\n                      shadow: true,\r\n                      intensity: 10,\r\n                      quality: 'high'\r\n                  },\r\n                  ambientCubemap: {\r\n                      texture: '/asset/get/s/data-1530248984324-SyeXJSmM7.hdr',\r\n                      exposure: 0,\r\n                      diffuseIntensity: 0.2\r\n                  }\r\n              }\r\n          },\r\n          series: [{\r\n              type: 'bar3D',\r\n              silent: true,\r\n              shading: 'lambert',\r\n              coordinateSystem: 'maptalks3D',\r\n              data: [],\r\n              barSize: 1,\r\n              lineStyle: {\r\n                  width: 4\r\n              },\r\n              animationDurationUpdate: UPDATE_DURATION\r\n          }]\r\n      }\r\n      myChart.setOption(option);\r\n      var map = myChart.getModel().getComponent('maptalks3D').getMaptalks();\r\n      console.log(map);","html":"","externalScripts":"https://deyihu.github.io/src/lib/echarts-gl.1.1.3.js?tdsourcetag=s_pctim_aiomsg,https://cdn.jsdelivr.net/npm/maptalks@0.40.1/dist/maptalks.min.js","updaterUID":"bd-3778831175","theme":"","layout":"","viewCount":558,"userName":"m***i","commentCount":1,"starCount":5,"isStared":0,"thumbnailURL":"https://www.makeapie.com/ecg-storage/ec_gallery_thumbnail/xHkfBcHmMQ.png?v=1530251835772","isCustomThumbnail":1,"builtinTags":["category-work","maptalks3D","series-bar3D","tooltip","visualMap"],"customTags":["Music"],"updaterUserName":"m***i"}}