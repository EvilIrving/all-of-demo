{"status":0,"data":{"cid":"xBySx4voLe","authorUid":"bd-1610942177","authorUserName":"i***t","title":"地图饼图","description":"地图集成饼图","latestVersion":9,"alwaysLatest":1,"createTime":"2017-01-17T09:29:17.000Z","lastUpdateTime":"2020-06-04T04:24:51.000Z","auth":2,"uid":"bd-1610942177","publishedVersion":0,"forkFrom":"-","isSpam":0,"version":9,"parentVersion":8,"echartsVersion":"3.4.0","versionCreateTime":"2017-03-14T06:33:25.000Z","code":"var districts = {\n    \"园区\": {\n        \"lat\": 31.328803977968,\n        \"lng\": 120.71463459445\n    },\n    \"新区\": {\n        \"lat\": 31.31123,\n        \"lng\": 120.551669\n    }\n};\n\nvar allData = {\n    \"直接访问\": {\n        \"district_count\": [{\n            \"district\": \"新区\",\n            \"count\": 1231\n        }]\n    },\n    \"邮件营销\": {\n        \"district_count\": [{\n            \"district\": \"园区\",\n            \"count\": 235\n        }, {\n            \"district\": \"新区\",\n            \"count\": 211\n        }]\n    },\n    \"联盟广告\": {\n        \"district_count\": [{\n            \"district\": \"新区\",\n            \"count\": 1231\n        }, {\n            \"district\": \"园区\",\n            \"count\": 205\n        }]\n    },\n    \"视频广告\": {\n        \"district_count\": [{\n            \"district\": \"园区\",\n            \"count\": 855\n        }]\n    }\n};\n\nvar option = {\n    // color: ['#85b6b2', '#6d4f8d','#cd5e7e', '#e38980','#f7db88'],\n    bmap: {\n        center: [120.631007, 31.308762],\n        zoom: 12,\n        roam: true,\n        enableMapClick: false,\n        mapStyle: {\n            styleJson: [{\n                \"featureType\": \"all\",\n                \"elementType\": \"all\",\n                \"stylers\": {\n                    \"lightness\": 61,\n                    \"saturation\": -70\n                }\n\n            }, {\n                \"featureType\": \"poi\",\n                \"elementType\": \"all\",\n                \"stylers\": {\n                    \"visibility\": \"off\"\n                }\n            }]\n        }\n    },\n    legend: {\n        show: false,\n        orient: 'vertical',\n        right: 20,\n        top: 15,\n        padding: 10,\n        backgroundColor: \"rgba(255,255,255,0.8)\",\n        data: []\n    },\n    series: [{\n        type: 'pie',\n        data: []\n    }]\n};\n\nmyChart.setOption(option);\n\nmyChart.on('legendselectchanged', function (params) {\n    console.log(params.name);\n    for(var prop in districtChart){\n        districtChart[prop].dispatchAction({\n            type: 'legendToggleSelect',\n            name:params.name\n        });\n    }\n});\nsetTimeout(init, 0);\n\n\nfunction init() {\n    initMap();\n    initPieDistrict(myChart, getMap());\n    showPie([\"直接访问\", \"邮件营销\", \"联盟广告\", \"视频广告\"]);\n    //showPie([\"直接访问\", \"联盟广告\", \"视频广告\"]);\n\n}\n\nfunction initMap() {\n    var top_left_navigation = new BMap.NavigationControl({\n        //type: BMAP_NAVIGATION_CONTROL_SMALL\n    });\n    var map = getMap();\n    //map.centerAndZoom(\"苏州\", 13);\n    map.addControl(top_left_navigation);\n    map.disableDoubleClickZoom();\n    map.removeEventListener(\"click\");\n    return map;\n}\n\n\nfunction getMap() {\n    return myChart.getModel().getComponent('bmap').getBMap();\n}\n\n// function initPieMarker(id, position) {\n//     var htm = '<div id=\"' + id + '\" style=\"width:200px;height:200px;\"></div>';\n//     var point = new BMap.Point(position.lng, position.lat);\n//     var myRichMarkerObject = new BMapLib.RichMarker(htm, point, {\n//         \"anchor\": new BMap.Size(-100, -100),\n//         barkground: \"transparent\"\n//     });\n//     var map = getMap();\n//     map.addOverlay(myRichMarkerObject);\n//     document.getElementById(id).parentNode.style.backgroundColor = \"transparent\";\n//     document.getElementById(id).parentNode.style.zIndex = \"1\";\n//     var myChart = echarts.init(document.getElementById(id), \"macarons\");\n//     var option = {\n//         tooltip: {\n//             trigger: 'item',\n//             formatter: \"{a} <br/>{b}: {c} ({d}%)\"\n//         },\n//         title: {\n//             text: \"园区\",\n//             left: \"center\",\n//             top: \"center\",\n//             textStyle: {\n//                 fontSize: 16,\n//                 fontWeight: \"bold\"\n//             }\n//         },\n\n//         series: [{\n//             name: '园区',\n//             type: 'pie',\n//             backgroundColor: \"rgba(255,255,255,0.8)\",\n//             avoidLabelOverlap: false,\n//             label: {\n//                 normal: {\n//                     show: false,\n//                     position: 'center',\n//                     formatter: \"{a}\"\n\n//                 }\n//             },\n//             radius: ['25', '40'],\n//             data: [{\n//                 value: 235,\n//                 name: '直接访问'\n//             }, {\n//                 value: 310,\n//                 name: '邮件营销'\n//             }, {\n//                 value: 234,\n//                 name: '联盟广告'\n//             }, {\n//                 value: 135,\n//                 name: '视频广告'\n//             }, {\n//                 value: 1548,\n//                 name: '搜索引擎'\n//             }]\n//         }]\n//     }\n//     myChart.setOption(option);\n// }\nvar districtPoint = districts;\nvar districtChart = {};\nvar districtLabels = [];\nvar parentChart = null;\n\nvar initPieDistrict = function(chart, map) {\n    parentChart = chart;\n    var count = 0;\n    for (var prop in districtPoint) {\n        var district = prop;\n        var position = districtPoint[prop];\n        var id = \"districtPoint\" + count++;\n        districtLabels.push(district);\n        districtChart[district] = initPieMarker(map, id, district, position);\n    }\n    //console.log(districtLabels);\n    //console.log(districtChart);\n}\n\n\n\nfunction initPieMarker(map, id, district, position) {\n    var htm = '<div id=\"' + id + '\" style=\"width:100px;height:100px;\"></div>';\n    var point = new BMap.Point(position.lng, position.lat);\n    var myRichMarkerObject = new BMapLib.RichMarker(htm, point, {\n        \"anchor\": new BMap.Size(-30, -30),\n        barkground: \"transparent\"\n    });\n    map.addOverlay(myRichMarkerObject);\n    document.getElementById(id).parentNode.style.backgroundColor = \"transparent\";\n    document.getElementById(id).parentNode.style.zIndex = \"1\";\n    var myChart = echarts.init(document.getElementById(id), \"macarons\");\n    var option = {\n        tooltip: {\n            trigger: 'item',\n            formatter: \"{a} <br/>{b}: {c} ({d}%)\"\n        },\n        \n        title: {\n            left: \"center\",\n            top: \"center\",\n            textStyle: {\n                fontSize: 14,\n                fontWeight: \"bold\"\n            }\n        },\n        series: [{\n            name: district,\n            type: 'pie',\n            avoidLabelOverlap: false,\n            label: {\n                normal: {\n                    show: false,\n                    position: 'center',\n                    formatter: \"{a}\"\n                }\n            },\n            radius: ['25', '40'],\n            data: []\n\n        }]\n    }\n    myChart.setOption(option);\n    return myChart;\n}\n\nfunction showPie(arr) {\n    let obj = {};\n    console.log(arr.length, \"len\")\n    districtLabels.forEach((i) => {\n        obj[i] = {};\n        arr.forEach((j) => {\n            console.log(j, \"xxx\")\n            obj[i][j] = 0;\n        });\n    });\n\n    console.log(obj, \"AA\")\n        //数据降维\n    for (let prop in allData) {\n        allData[prop].district_count.forEach((i) => {\n            if (obj[i.district][prop] === 0) {\n                obj[i.district][prop] = i.count;\n            }\n        });\n    }\n    console.log(obj);\n    setData(obj, arr);\n}\n\nvar placeHolderStyle = {\n    normal : {\n        color: 'rgba(255,255,255,0.8)',\n        label: {show:false},\n       \n        labelLine: {show:false}\n    },\n    emphasis : {\n        color: 'rgba(0,0,0,0)'\n    }\n};\n\nfunction setData(data, label) {\n\n    districtLabels.forEach((district) => {\n        var count = 0;\n        var dt = (data[district]);\n        var newPieData = [];\n        for (let prop in dt) {\n            newPieData.push({\n                name: prop,\n                value: dt[prop]\n            });\n            count += dt[prop];\n        }\n        console.log(newPieData);\n\n        if (count === 0) {\n            newPieData = [];\n        }\n        districtChart[district].setOption({\n            title: {\n                show: count > 0,\n                text: district\n            },\n            legend: {\n                show:  false,\n                data: label\n            },\n            series: [{\n                data: newPieData\n            }, {\n                tooltip:{show:false},\n                type: 'pie',\n                radius: [0, 25],\n                data: [{\n                    value: 0,\n                    itemStyle : placeHolderStyle\n                }]\n            }]\n        })\n    });\n    let labelName = label.map((i) => {\n        return {\n            name: i\n        };\n    });\n\n    //修改parentChart\n    parentChart.setOption({\n        legend: {\n            show: (label.length > 0),\n            data: label\n        },\n        series: [{\n            data: labelName\n        }]\n    });\n}","html":"","externalScripts":"/dep/echarts/latest/extension/bmap.min.js,http://api.map.baidu.com/api?v=2.0&ak=ZUONbpqGBsYGXNIYHicvbAbM,http://api.map.baidu.com/library/RichMarker/1.2/src/RichMarker_min.js","updaterUID":"bd-1610942177","theme":"default","layout":"","viewCount":16053,"userName":"i***t","commentCount":16,"starCount":52,"isStared":0,"thumbnailURL":"https://www.makeapie.com/ecg-storage/ec_gallery_thumbnail/xBySx4voLe.png?v=1591244691951","isCustomThumbnail":1,"builtinTags":["category-work"],"customTags":["bmap","pie","码上生花"],"updaterUserName":"i***t"}}