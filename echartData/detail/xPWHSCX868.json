{"status":0,"data":{"cid":"xPWHSCX868","authorUid":"obd-ol9ApUNzruRtm2D-0e5Fb-FETwsWF0O","authorUserName":"相***光","title":"首要污染物准确率评估","description":"AQI预测 - 预测准确性评估 - 首要污染物准确率评估","latestVersion":1,"alwaysLatest":0,"createTime":"2021-10-28T07:31:03.000Z","lastUpdateTime":"2021-10-28T07:31:03.000Z","auth":2,"uid":"obd-ol9ApUNzruRtm2D-0e5Fb-FETwsWF0O","publishedVersion":0,"forkFrom":"-","isSpam":0,"version":1,"parentVersion":-1,"echartsVersion":"5.2.1","versionCreateTime":"2021-10-28T07:31:03.000Z","code":"const uploadedDataURL = '/asset/get/s/data-1635390802457-HRSoVX4EN.json';\r\n\r\nconst symbolPass =\r\n  'image://data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNjM0MjAwNDAzNDA1IiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjI1MDAiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCI+PGRlZnM+PHN0eWxlIHR5cGU9InRleHQvY3NzIj48L3N0eWxlPjwvZGVmcz48cGF0aCBkPSJNNTEyIDEwMjRDMjI5LjI0OCAxMDI0IDAgNzk0Ljc1MiAwIDUxMlMyMjkuMjQ4IDAgNTEyIDBzNTEyIDIyOS4yNDggNTEyIDUxMi0yMjkuMjQ4IDUxMi01MTIgNTEyeiBtLTExNC4xNzYtMzEwLjk1NDY2N2E1My4zMzMzMzMgNTMuMzMzMzMzIDAgMCAwIDc1LjQzNDY2NyAwbDMyMy4zMjgtMzIzLjMyOGE1My4zMzMzMzMgNTMuMzMzMzMzIDAgMSAwLTc1LjQzNDY2Ny03NS40MzQ2NjZsLTI4Ny45MTQ2NjcgMjgzLjMwNjY2Ni0xMjguODUzMzMzLTEyOC44NTMzMzNhNTMuMzMzMzMzIDUzLjMzMzMzMyAwIDEgMC03NS40MzQ2NjcgNzUuNDM0NjY3bDE2OC44NzQ2NjcgMTY4Ljg3NDY2NnoiIGZpbGw9IiMxYWZhMjkiIHAtaWQ9IjI1MDEiIGRhdGEtc3BtLWFuY2hvci1pZD0iYTMxM3guNzc4MTA2OS4wLmkwIiBjbGFzcz0iIj48L3BhdGg+PC9zdmc+';\r\nconst symbolFail =\r\n  'image://data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/PjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+PHN2ZyB0PSIxNjM0MjgwMDM2OTY5IiBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHAtaWQ9IjIwOTkiIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCI+PGRlZnM+PHN0eWxlIHR5cGU9InRleHQvY3NzIj48L3N0eWxlPjwvZGVmcz48cGF0aCBkPSJNNTEyIDMyQzI1MS40Mjg1NzE1NjI1IDMyIDMyIDI1MS40Mjg1NzE1NjI1IDMyIDUxMnMyMTkuNDI4NTcxNTYyNSA0ODAgNDgwIDQ4MCA0ODAtMjE5LjQyODU3MTU2MjUgNDgwLTQ4MC0yMTkuNDI4NTcxNTYyNS00ODAtNDgwLTQ4MHogbTIwNS43MTQyODUzMTI1IDYxNy4xNDI4NTY4NzVjMjAuNTcxNDI4NDM3NSAyMC41NzE0Mjg0Mzc1IDIwLjU3MTQyODQzNzUgNDggMCA2MS43MTQyODYyNDk5OTk5OTQtMjAuNTcxNDI4NDM3NSAyMC41NzE0Mjg0Mzc1LTQ4IDIwLjU3MTQyODQzNzUtNjEuNzE0Mjg1MzEyNDk5OTk2IDBsLTEzNy4xNDI4NTY4NzUtMTM3LjE0Mjg1NzgxMjVMMzc0Ljg1NzE0MzEyNSA3MTcuNzE0Mjg1MzEyNWMtMjAuNTcxNDI4NDM3NSAyMC41NzE0Mjg0Mzc1LTQ4IDIwLjU3MTQyODQzNzUtNjguNTcxNDI4NDM3NSAwcy0yMC41NzE0Mjg0Mzc1LTU0Ljg1NzE0MzEyNSAwLTY4LjU3MTQyODQzNzVsMTQ0LTE0NC0xMzcuMTQyODU3ODEyNS0xMzcuMTQyODU2ODc1Yy0yMC41NzE0Mjg0Mzc1LTEzLjcxNDI4NTMxMjUwMDAwMS0yMC41NzE0Mjg0Mzc1LTQxLjE0Mjg1Njg3NSAwLTYxLjcxNDI4NTMxMjQ5OTk5NiAyMC41NzE0Mjg0Mzc1LTIwLjU3MTQyODQzNzUgNDgtMjAuNTcxNDI4NDM3NSA2MS43MTQyODYyNDk5OTk5OTQgMGwxMzcuMTQyODU2ODc1IDEzNy4xNDI4NTY4NzUgMTQ0LTE0NGMyMC41NzE0Mjg0Mzc1LTIwLjU3MTQyODQzNzUgNDgtMjAuNTcxNDI4NDM3NSA2OC41NzE0Mjg0Mzc1IDAgMjAuNTcxNDI4NDM3NSAyMC41NzE0Mjg0Mzc1IDIwLjU3MTQyODQzNzUgNDggMCA2OC41NzE0Mjg0Mzc1TDU4MC41NzE0Mjg0Mzc1IDUxMmwxMzcuMTQyODU2ODc1IDEzNy4xNDI4NTY4NzV6IiBmaWxsPSIjZjE1MDQ3IiBwLWlkPSIyMTAwIj48L3BhdGg+PC9zdmc+';\r\n\r\nconst colors = ['#5470c6', '#91cc75', '#fac858', '#ee6666', '#73c0de', '#3ba272', '#fc8452', '#9a60b4', '#ea7ccc'];\r\n\r\n// AQI 等级\r\nconst AQI_LEVELS = [\r\n  {\r\n    icon: 'k1',\r\n    label: '优',\r\n    otherName: '一级',\r\n    value: 1,\r\n    min: 0,\r\n    max: 50,\r\n    proposal: '空气质量令人满意，基本无空气污染',\r\n    influence: '各类人群可正常活动',\r\n    color: '#00E500',\r\n    lightColor: '#D2F5A5',\r\n  },\r\n  {\r\n    icon: 'k2',\r\n    label: '良',\r\n    otherName: '二级',\r\n    value: 2,\r\n    min: 51,\r\n    max: 100,\r\n    proposal: '空气质量可接受，但某些污染物可能对极少数异常敏感人群健康有较弱影响',\r\n    influence: '极少数异常敏感人群应减少户外活动',\r\n    color: '#FFFF00',\r\n    lightColor: '#EBEBD8',\r\n  },\r\n  {\r\n    icon: 'k3',\r\n    label: '轻度',\r\n    otherName: '三级',\r\n    value: 3,\r\n    min: 101,\r\n    max: 150,\r\n    proposal: '易感人群症状有轻度加剧，健康人群出现刺激症状',\r\n    influence: '儿童、老年人及心脏病、呼吸系统疾病患者应减少长时间、高强度的户外锻炼',\r\n    color: '#FF7E00',\r\n    lightColor: '#F2E1C7',\r\n  },\r\n  {\r\n    icon: 'k4',\r\n    label: '中度',\r\n    otherName: '四级',\r\n    value: 4,\r\n    min: 151,\r\n    max: 200,\r\n    proposal: '进一步加剧易感人群症状，可能对健康人群心脏、呼吸系统有影响',\r\n    influence: '儿童、老年人及心脏病、呼吸系统疾病患者避免长时间、高强度的户外锻炼，一般人群适量减少户外运动',\r\n    color: '#FE0000',\r\n    lightColor: '#F3D3D3',\r\n  },\r\n  {\r\n    icon: 'k5',\r\n    label: '重度',\r\n    otherName: '五级',\r\n    value: 5,\r\n    min: 201,\r\n    max: 300,\r\n    proposal: '心脏病和肺病患者症状显著加剧，运动耐受力降低，健康人群普遍出现症状',\r\n    influence: '儿童、老年人及心脏病、肺病患者应停留在室内，停止户外运动，一般人群减少户外运动',\r\n    color: '#99004C',\r\n    lightColor: '#E5D2ED',\r\n  },\r\n  {\r\n    icon: 'k6',\r\n    label: '严重',\r\n    otherName: '六级',\r\n    value: 6,\r\n    min: 301,\r\n    max: '+',\r\n    proposal: '健康人群运动耐受力降低，有明显强烈症状，提前出现某些疾病',\r\n    influence: '儿童、老年人和病人应停留在室内，避免体力消耗，一般人群避免户外活动',\r\n    color: '#7E0022',\r\n    lightColor: '#F3CBD7',\r\n  },\r\n];\r\n\r\n/**\r\n * @description 获取AQI等级\r\n * @params {number} value\r\n */\r\n//  获取AQI等级\r\nconst getLevel = (value) => {\r\n  let index = 0;\r\n  if (!value || value <= 50) index = 0;\r\n  if (value > 50 && value <= 100) index = 1;\r\n  if (value > 100 && value <= 150) index = 2;\r\n  if (value > 150 && value <= 200) index = 3;\r\n  if (value > 200 && value <= 300) index = 4;\r\n  if (value > 300) index = 5;\r\n  return { index, ...AQI_LEVELS[index] };\r\n};\r\n\r\n// 首要污染物别名配置\r\nconst PRIMARY = {\r\n  NA: '无',\r\n};\r\n\r\n// 获取首要污染物Label\r\nconst getPrimaryLabel = (value) => {\r\n  if (!value) return '';\r\n  if (PRIMARY[value]) return PRIMARY[value];\r\n  return value;\r\n};\r\n\r\n// 获取渐变颜色范围\r\nconst colorRange = (startColor, endColor) => ({\r\n  type: 'linear',\r\n  x: -0.33,\r\n  y: 0.5,\r\n  colorStops: [\r\n    { offset: 0, color: startColor }, // 0% 处的颜色\r\n    { offset: 0.5, color: startColor },\r\n    { offset: 0.5, color: endColor },\r\n    { offset: 1, color: endColor }, // 100% 处的颜色\r\n  ],\r\n  global: false, // 缺省为 false\r\n});\r\n\r\n// 获取趋势\r\nconst getTrend = (history, forecast) => {\r\n  if (history === null || forecast === null) return '';\r\n  const historyLevel = getLevel(history);\r\n  const forecastLevel = getLevel(forecast);\r\n  if (historyLevel.label === forecastLevel.label) return '正确';\r\n  return history < forecast ? '偏高' : '偏低';\r\n};\r\n\r\n// 获取趋势标记符号\r\nconst getSymbol = (history, forecast) => {\r\n  if (history === null || forecast === null) return '';\r\n  return history === forecast ? symbolPass : symbolFail;\r\n};\r\n\r\n// 获取悬浮提示元素\r\nconst getTooltipRow = (params, factors) => {\r\n  return `\r\n  <div style=\"display: flex; justify-content: space-between; padding-top: 3px;\">\r\n    <span>${params.value[1] ? '实况监测' : '模式预测'}</span>\r\n    <span style=\"padding-left: 15px\">${params.marker || ''}</span>\r\n    <span>${factors[params.value[2]] || '-'}</span>\r\n  </div>`;\r\n};\r\n\r\n/**\r\n * @description 将接口数据转化为符合 echarts 的数据\r\n * @param {array} history 历史数据\r\n * @param {array} forecast 预测数据\r\n * @param {boolean} diff 是否按AQI等级拆分数据\r\n * @returns echartsData 符合echarts配置数据\r\n */\r\nconst transformData = (history, forecast, isDiff = false) => {\r\n  const xAxisData = [...new Set([...Object.keys(history)])].sort();\r\n  const yAxisData = ['模式预测', '实况监测'];\r\n\r\n  let seriesData = [];\r\n  let seriesDatas = [];\r\n  const markPointData = [];\r\n  const factors = [];\r\n\r\n  for (let i = 0; i < xAxisData.length; i++) {\r\n    for (let j = 0; j < yAxisData.length; j++) {\r\n      const key = xAxisData[i];\r\n      const historyValue = getPrimaryLabel((history[key] || {}).primary) || null;\r\n      const forecastValue = getPrimaryLabel((forecast[key] || {}).primary) || null;\r\n      seriesData.push([i, j, j ? historyValue : forecastValue]);\r\n      if (!factors.includes(historyValue)) factors.push(historyValue);\r\n      if (!factors.includes(forecastValue)) factors.push(forecastValue);\r\n      if (j) {\r\n        const symbol = getSymbol(historyValue, forecastValue);\r\n        markPointData.push({\r\n          show: Boolean(symbol),\r\n          xAxis: i,\r\n          yAxis: 1,\r\n          symbolSize: 20,\r\n          symbol,\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  seriesData = seriesData.map(([x, y, factor]) => {\r\n    const index = factors.findIndex((v) => v === factor);\r\n    return [x, y, index];\r\n  });\r\n\r\n  // 按AQI等级区分数据\r\n  if (isDiff) {\r\n    seriesDatas = factors.map((v, i) => {\r\n      const data = seriesData.filter((v) => v[2] === i);\r\n      const color = v === '无' ? '#EFEFEF' : colors[i];\r\n      return { name: v, data, color };\r\n    });\r\n  }\r\n\r\n  return { xAxisData, yAxisData, seriesData, seriesDatas, markPointData, factors };\r\n};\r\n\r\n$.getJSON(uploadedDataURL, (data) => {\r\n  const { history, forecast } = data;\r\n  console.log(data);\r\n  const { xAxisData, yAxisData, seriesDatas, markPointData, factors } = transformData(\r\n    history || {},\r\n    forecast || {},\r\n    true\r\n  );\r\n  const myOption = {\r\n    title: {\r\n      text: '首要污染物准确率评估',\r\n      left: 'center',\r\n    },\r\n    grid: {\r\n      height: 80,\r\n      top: 70,\r\n      left: 58,\r\n      right: 10,\r\n      bottom: 50,\r\n    },\r\n    xAxis: {\r\n      type: 'category',\r\n      data: xAxisData,\r\n      splitArea: {\r\n        show: true,\r\n      },\r\n      axisLine: {\r\n        show: false,\r\n      },\r\n      axisTick: {\r\n        show: false,\r\n      },\r\n    },\r\n    yAxis: [\r\n      {\r\n        type: 'category',\r\n        data: yAxisData,\r\n        axisLine: {\r\n          show: false,\r\n        },\r\n        axisTick: {\r\n          show: false,\r\n        },\r\n      },\r\n      {\r\n        type: 'value',\r\n      },\r\n    ],\r\n    legend: {\r\n      show: true,\r\n      icon: 'circle',\r\n      bottom: 0,\r\n    },\r\n    tooltip: {\r\n      position: 'top',\r\n      trigger: 'axis',\r\n      formatter: (params) => {\r\n        if (params.length !== 2) return '';\r\n        const [paramsOne, paramsTwo] = params;\r\n        const result = [];\r\n        const dateStr = (paramsTwo || {}).axisValue || (paramsOne || {}).axisValue;\r\n        if (dateStr) result.push(dateStr);\r\n        if (paramsOne.value[1]) {\r\n          if (paramsOne) result.push(getTooltipRow(paramsOne, factors));\r\n          if (paramsTwo) result.push(getTooltipRow(paramsTwo, factors));\r\n        } else {\r\n          if (paramsTwo) result.push(getTooltipRow(paramsTwo, factors));\r\n          if (paramsOne) result.push(getTooltipRow(paramsOne, factors));\r\n        }\r\n        return result.join('');\r\n      },\r\n    },\r\n    visualMap: [\r\n      {\r\n        show: false,\r\n        type: 'piecewise',\r\n        pieces: factors.map((v, i) => ({\r\n          value: i,\r\n          name: v,\r\n          color: v === '无' ? '#EFEFEF' : colors[i],\r\n        })),\r\n      },\r\n    ],\r\n    series: [\r\n      {\r\n        type: 'line',\r\n        color: '#41C15A',\r\n        markPoint: {\r\n          symbolOffset: [0, -35],\r\n          data: markPointData,\r\n        },\r\n      },\r\n      ...seriesDatas.map(({ name, data, color }) => ({\r\n        name,\r\n        data,\r\n        type: 'heatmap',\r\n        label: {\r\n          show: true,\r\n          formatter: (params) => {\r\n            if (!params.value.length) return '';\r\n            return factors[params.value[2]];\r\n          },\r\n        },\r\n        itemStyle: {\r\n          color,\r\n          borderWidth: 2,\r\n          borderColor: '#fff',\r\n        },\r\n      })),\r\n    ],\r\n  };\r\n  myChart.setOption(myOption);\r\n});\r\n","html":"","externalScripts":"","updaterUID":"obd-ol9ApUNzruRtm2D-0e5Fb-FETwsWF0O","theme":"","layout":"","viewCount":0,"userName":"相***光","commentCount":0,"starCount":5,"isStared":0,"thumbnailURL":"https://www.makeapie.com/ecg-storage/ec_gallery_thumbnail/xPWHSCX868.png?v=1635406264179","isCustomThumbnail":1,"builtinTags":["category-work","grid","legend","markPoint","series-heatmap","series-line","title","tooltip","visualMap"],"customTags":[],"updaterUserName":"相***光"}}