# 浙里办
## MGOP
在浙里办的容器里我们没法在服务器里配置Nginx，所以所有的接口请求在浙里办的线上环境里都是跨域的，因此必须使用Mgop来包装我们的请求，通过官方提供的[MGOP](https://www.yuque.com/xiaoniaoge/run4dl/dge18k) (一个封装好的js库：@aligov/jssdk-mgop)来解决跨域问题。
### 接口配置
将可用接口配置到政务中台的应用开发管理平台里面的 rpc接入 并且调试好上线，这个地方需要提前申请开通服务，如果没有申请接入是会有跨域报错或者页面白屏的状态。API管理--》新建API --》--》配置API名称--》 配置API地址 --》配置API入参出参  
>开发过程中使用Axios，线上发布的时候需要用另外MGOP来发送API请求，因此需要通过Node.js的环境变量，区分两种不同的封装方式发送同一套接口请求。  
调试过程使用`浙里办app`或者使用官方提供的`debug工具`做为调试依据

路由模式改成 hash 模式，仿照axios的传参数方式，配合上官方给出的MGOP使用说明把MGOP封装成一个Promise方法，
```javascript
/* ./src/utils/mgop.js */

import { mgop } from '@aligov/jssdk-mgop'
import { getToken } from '@/utils/auth.js'
import { showLoading, hideLoading, destoryLoading } from '@/utils/loading.js'

export const mgopRequest = (payload) => {
  return new Promise((resolve, reject) => {
    showLoading()
    // 仿照axios的传参方式
    const data = Object.assign({}, {
        api: payload.zwApi, // 必须,政务中台rpc接口的制定名字。例如‘mgop.xxx.app.login’
        host: 'https://mapi.zjzwfw.gov.cn/',// 固定为这个地址
        dataType: payload.dataType || 'json', // 目前官方只支持JSON格式
        data: payload.data || payload.params, // 不管入参是query还是body都同意用data传入，到时候在工作台里配置即可
        type: payload.method, // 和axios一样
        isBuffer: payload.isBuffer, 
        appKey: 'xxxx', // 必须，政务中台appKey, 系统申请之后大数据局发过来的excel里有
        // 成功后的回调
        onSuccess: data => {
          console.log(data.data)
          hideLoading()
          resolve(data)
        },
        // 请求失败后的回调
        onFail: err => {
          console.log(err, 'err')
          destoryLoading()
          reject(err.message)
        }
      },  
      // 是否需要传JWT令牌,对于登录和一些免登接口，payload.noToken = true
      payload.noToken ? 
      {} : 
      { header: { Authorization: 'Bearer ' + getToken() } }
    )
    mgop(data)
  })
}
```
###
```nodejs
 npm i --save @aligov/jssdk-mgop@3.0.0
```
## 老人版
适合化的要求是提供两套UI方案，在用户切换浙里办App中的长辈版后切换到“大字体”版本。使用浙江政务提供的 [zwjsBridge](https://jssdk.yyhj.zjzwfw.gov.cn/site/readme)的UI功能。具体步骤：
#### 插入JSBridge
在入口的/public/index.html中插入JSBridge <!-- ZWJSBridge使用1.0.1版本的 --> 
 ```html
<!--  在head标签中插入 -->
<head>
<script type="text/javascript" src="//assets.zjzwfw.gov.cn/assets/ZWJSBridge/1.0.1/zwjsbridge.js" />
</head>
<!-- 其他部分省略 -->
 ```
#### 调用JSBridge
进入H5后调用JSBridge检查当前用户的uiStyle，如果为然后把这个状态储存在Vuex里。
```javascript
/* ./src/composables/uiStyle */
import store from '@/store'

export const getUIStyle = () => {
  ZWJSBridge.onReady(() => {
    console.log('zwjsbrige 可调用')
    ZWJSBridge.getUiStyle()
      .then((result) => {
        const { uiStyle } = result
        store.dispatch('SetUIStyle', uiStyle)
        console.log(`store存储为: ${store.getters.uiStyle}`)
    })
      .catch((error) => {
        console.log(error)
        store.dispatch('SetUIStyle', 'normal')
      })
  })
}
```
#### 创建mutation和action
有关浙里办的部分单独写在一个module下面,uiStyle这个属性可以在在store的getters里面单独暴露出来。
```javascript
/* ./src/store/modules/zwjs */

const zwjs = {
  state: {
    // long: '', // 纬度埋点
    // lati: '' //经度埋点,
    // ticket: null, 
    uiStyle: null,
  }, 
  mutations: {
    SET_UISTYLE: (state, style) => {
      if(!style) return
      state.uiStyle = style
    }
  },
  actions: {
    SetUIStyle({ commit }, payload) {
      commit('SET_UISTYLE', payload)
    }
  }
}
```
#### 储存全局状态
渲染的时候就要根据store中存储的uiStyle字段动态判断某个元素所采用的css类
```Vue
// xxx.vue中
<script>
export default {
  computed: {
    ...mapGetters(['uiStyle']),
  }
}
</script>

<style lang="less" scoped>
  .title {

  }
  .title--elder {

  }
</style>

<template>
  <div>
  <div :class="$store.getters.uiStyle === 'elder' ? 'title--elder' : 'title'">
      标题
    </div>
  </div>
</template>
```
## 单点登录 
单点登录分为支付宝小程序登录、APP登录还有微信小程序里面的浙里办小程序登录（新增）;浙里APP和支付宝小程序的判断

```
// 浙里APP和支付宝小程序环境的判断
const sUserAgent = window.navigator.userAgent.toLowerCase()
// 浙里办APP
const bIsDtDreamApp = sUserAgent.indexOf('dtdreamweb') > -1
// 浙里办支付宝小程序
const bIsAlipayMini = sUserAgent.indexOf('miniprogram') > -1 && sUserAgent.indexOf('alipay') > -1
if(bIsAlipayMini){
   location.href = "https://puser.zjzwfw.gov.cn/sso/alipay.do?action=ssoLogin&citycode=&servicecode=接入码&redirectUrl=回调地址";
 }else{
   location.href = 'https://puser.zjzwfw.gov.cn/sso/mobile.do?action=oauth&servicecode=接入码&redirectUrl=回调地址'
 }

```
###微信小程序登录需要引入zwjsbridge.js,在public文件夹里面index.html中添加
```
<script type="text/javascript" src="//assets.zjzwfw.gov.cn/assets/ZWJSBridge/1.1.0/zwjsbridge.js"></script>
<script>
	ZWJSBridge.onReady(() => {
      console.log('初始化完成后，执行bridge方法')
    })
</script>
```
使用ZWJSBridge进行微信小程序的登录
```
if (ZWJSBridge.ssoTicket) {
	let _self = this
   const ssoFlag = await ZWJSBridge.ssoTicket({});
   if (ssoFlag && ssoFlag.result === true) {
        //使用 IRS“浙里办”单点登录组件
        if (ssoFlag.ticketId) {
          _self.weiLogin(ssoFlag.ticketId)  //使用ticketId获取token
        } else {
          //当“浙里办”单点登录失败或登录态失效时调用 ZWJSBridge.openLink 方法重新获取 ticketId。
          ZWJSBridge.openLink({
            type: "reload"
          }).then(res => {
            _self.weiLogin(ssoFlag.ticketId) //使用ticketId获取token
          })
     }
  }
```

# 引用
* [浙里办上架的一些注意事项](https://juejin.cn/post/7005871168733315085)