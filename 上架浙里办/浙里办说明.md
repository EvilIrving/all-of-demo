# IRS 上架资料汇总

## 本地调试应用
下载「政务中台Debug工具」，需要登录，账号需要找业主要（非浙政钉账号）。登录之后需要用手机上的浙里办扫码关联，并且浙里办在调试过程中要一直在前台运行，不能锁屏。输入自己的本地url开始调试。
## 引入[sdk](https://op-irs.zj.gov.cn/mobile/login?goto=/mobile/documents/technology/1714076105479)
在window挂载ZWJSBridge变量，在ZWJSBridge上调用各种sdk能力
```
  <script src="//assets.zjzwfw.gov.cn/assets/ZWJSBridge/1.0.1/zwjsbridge.js"></script>
```
## 接口注册
* 浙里办要求所有的接口调用都必须走他们的网关中转，因此所有接口都要在开发商工作台内进行注册。API名称不可重复。「API是否需要登录」 只能选「否」
* 生产环境和联调环境目标地址都要是HTTPS。
* 参数映射关系，关键要选择正确的传参方式，两种方式不能混用。其他入参出参可以不填，网关都是透传的。需要注意的是，不支持动态路由传参
* RPC网关不支持文件流格式，转为base64上传；或自行实现
* 生产环境目标地址、联调环境目标地址 皆是 应用系统服务端API接口地址， 不涉及本地（localhost）环境
* 部署后在IRS平台联调时接口需携带token
## MGOP
官方提供的[MGOP](https://www.yuque.com/xiaoniaoge/run4dl/dge18k) (一个封装好的js库：@aligov/jssdk-mgop)来解决跨域问题。
### 接口配置
将可用接口配置到政务中台的应用开发管理平台里面的 rpc接入 并且调试好上线，这个地方需要提前申请开通服务，如果没有申请接入是会有跨域报错或者页面白屏的状态。API管理--》新建API --》--》配置API名称--》 配置API地址 --》配置API入参出参 ；调试过程使用`浙里办app`或者使用官方提供的`debug工具`做为调试依据

路由模式改成 hash 模式，仿照axios的传参数方式，配合上官方给出的MGOP使用说明把MGOP封装成一个Promise方法，
```javascript
/* ./src/utils/mgop.js */

import { mgop } from '@aligov/jssdk-mgop'
import { getToken } from '@/utils/auth.js'
import { showLoading, hideLoading, destoryLoading } from '@/utils/loading.js'

export const mgopRequest = (payload) => {
  return new Promise((resolve, reject) => {
    showLoading()
    // 仿照axios的传参方式
    const data = Object.assign({}, {
        api: payload.zwApi, // 必须,政务中台rpc接口的制定名字。例如‘mgop.xxx.app.login’
        host: 'https://mapi.zjzwfw.gov.cn/',// 固定为这个地址
        dataType: payload.dataType || 'json', // 目前官方只支持JSON格式
        data: payload.data || payload.params, // 不管入参是query还是body都同意用data传入，到时候在工作台里配置即可
        type: payload.method, // 和axios一样
        isBuffer: payload.isBuffer, 
        appKey: 'xxxx', // 必须，政务中台appKey, 系统申请之后大数据局发过来的excel里有
        // 成功后的回调
        onSuccess: data => {
          console.log(data.data)
          hideLoading()
          resolve(data)
        },
        // 请求失败后的回调
        onFail: err => {
          console.log(err, 'err')
          destoryLoading()
          reject(err.message)
        }
      },  
      // 是否需要传JWT令牌,对于登录和一些免登接口，payload.noToken = true
      payload.noToken ? 
      {} : 
      { header: { Authorization: 'Bearer ' + getToken() } }
    )
    mgop(data)
  })
}
```
### 引入jsbridge
```nodejs
 npm i --save @aligov/jssdk-mgop@3.0.0
```
 ```html
<!--  在head标签中插入 -->
<head>
<script type="text/javascript" src="//assets.zjzwfw.gov.cn/assets/ZWJSBridge/1.0.1/zwjsbridge.js" />
</head>
<!-- 其他部分省略 -->
 ```
# 引用
文章
* [浙里办上架的一些注意事项](https://juejin.cn/post/7005871168733315085)
* [jssdk-mgop 文档](https://www.yuque.com/xiaoniaoge/run4dl/dge18k?)
* [浙江政务服务JSBridge](https://portal.zjzwfw.gov.cn/assets/jsbridge/1.0.0/public/site/index.html)
* [专有钉钉开发文档](https://openplatform-portal.dg-work.cn/portal/#/helpdoc?apiType=DEV_GUIDE&docKey=3355041)
* [单点登录、适老化、埋点、mgop网关依赖](https://blog.csdn.net/qq_43158069/article/details/127241564)
* [使用vue框架搭建浙里办微应用](https://www.jianshu.com/p/29028554cc79) 
* [浙里办/IRS系统H5应用开发避坑指南](https://juejin.cn/post/7051414893253099551)   
* [分别构建使用mgop和axios的包](https://juejin.cn/post/7139758368919322655)
* [maidian](https://juejin.cn/post/7168395769483886600)

工具
* [内网穿透工具pierced](https://github.com/open-dingtalk/pierced)
* [真机调试vConsole](https://juejin.cn/post/7005871168733315085)
* [Debug调试工具ZWEurope](https://juejin.cn/post/7005871168733315085)：业主负责人老师的账号登录政务中台找到调试工具下载Mac或者Windows版本的应用即可。