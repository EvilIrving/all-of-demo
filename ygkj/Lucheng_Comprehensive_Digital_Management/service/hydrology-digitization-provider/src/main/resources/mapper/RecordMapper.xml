<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ygkj.digitization.mapper.RecordMapper">

    <insert id="saveCatalog">
        INSERT INTO att_record_catalog_base
            (id,parent_id,`name`,sort,create_by)
        VALUES
            (#{id},#{parentId},#{name},#{sort},#{createBy})
    </insert>

    <insert id="saveRecord">
        INSERT INTO att_record_base
            (id,file_id,file_name,file_size,
             file_type,catalog_id,remark,create_time,
             uploader_id,uploader_name,dept_id)
        VALUES
            (#{id},#{fileId},#{fileName},#{fileSize},
             #{fileType},#{catalogId},#{remark},NOW(),
             #{uploaderId},#{uploaderName},#{deptId})
    </insert>

    <update id="updateRecord">
        UPDATE
            att_record_base
        SET
            file_id = #{fileId},
            file_name = #{fileName},
            file_size = #{fileSize},
            file_type = #{fileType},
            remark = #{remark}
        WHERE
            id = #{id}
    </update>

    <select id="selectRecord" resultType="com.ygkj.digitization.vo.response.RecordResVo">
        SELECT
            a.id,
            a.file_id,
            a.file_name,
            a.file_size,
            a.file_type,
            a.remark,
            a.create_time,
            a.uploader_name,
            b.name AS category,
            c.file_url
        FROM
            att_record_base a
            LEFT JOIN att_record_catalog_base b ON a.catalog_id = b.id
            LEFT JOIN lc_basic_db.sys_file c ON a.file_id = c.id
        WHERE
            a.id = #{id}
    </select>

    <select id="countFileByCatalog" resultType="com.ygkj.digitization.vo.response.CatalogResVo">
        SELECT
            COUNT(*) `count`, catalog_id id
        FROM
            att_record_base
        WHERE
            del_flag = 0
        GROUP BY
            catalog_id
    </select>

    <select id="listRecord" resultType="com.ygkj.digitization.vo.response.RecordListResVo">
        SELECT
           id,file_id,file_name,file_type,
           uploader_name,create_time
        FROM
            att_record_base
        WHERE
            del_flag = 0
            <if test="fileType != null and fileType != ''">
                AND file_type = #{fileType}
            </if>
            <if test="catalogList != null and catalogList.size > 0">
                AND catalog_id IN
                <foreach collection="catalogList" open="(" item="item" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="date != null and date != ''">
                AND create_time BETWEEN #{startTime} AND #{endTime}
            </if>
            <if test="fileName != null and fileName != ''">
                AND file_name LIKE CONCAT('%',#{fileName},'%')
            </if>
    </select>

    <select id="selectCatalogsByCondition" resultType="com.ygkj.digitization.vo.response.CatalogResVo">
        SELECT
	    a.id,
	    a.parent_id,
	    a.`name`,
	    a.create_by,
	    a.create_time,
	    COUNT( b.id ) AS child_number
        FROM
	    att_record_catalog_base a
	    LEFT JOIN att_record_catalog_base b ON a.id = b.parent_id AND b.del_flag = 0
        WHERE
	    a.del_flag = 0
	    <if test="parentId != null and parentId != ''">
            AND a.parent_id = #{parentId}
        </if>
        <if test="name != null and name != ''">
            AND a.name LIKE CONCAT(#{name},'%')
        </if>
        GROUP BY a.id
    </select>
</mapper>